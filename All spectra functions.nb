(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    180293,       4308]
NotebookOptionsPosition[    177207,       4249]
NotebookOutlinePosition[    177556,       4264]
CellTagsIndexPosition[    177513,       4261]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"<<", "QMRITools`"}]], "Input",
 CellChangeTimes->{{3.7729520143081813`*^9, 3.7729520168959804`*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"e87bfa00-329f-4381-911b-60eb90e20db1"],

Cell[CellGroupData[{

Cell["Spectra Functions", "Subsection",
 CellChangeTimes->{{3.7729515086744146`*^9, 
  3.772951514629675*^9}},ExpressionUUID->"d60b526a-3d3a-464b-9c8a-\
bf93e405e86b"],

Cell[CellGroupData[{

Cell["Spectra Fitting", "Subsubsection",
 CellChangeTimes->{{3.7729644771209445`*^9, 
  3.7729644815250425`*^9}},ExpressionUUID->"6be6feff-d302-4d2e-8df0-\
7736d77183ea"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "FitBasisSpectraI", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FitBasisSpectraI", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Output", "\[Rule]", "\"\<Error\>\""}], ",", 
      RowBox[{"MaxIterations", "\[Rule]", "3"}], ",", 
      RowBox[{"SpectraMetaboliteBaseline", "\[Rule]", "None"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FitBasisSpectraI", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ppmFull_", ",", "timeFull_", ",", "timeBasis_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"ppmY_", ",", "specY_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"indSt_", ",", "indEnd_"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"cpn_", ",", "gyro_"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"gam_", "?", "NumericQ"}], ",", 
       RowBox[{"eps_", "?", "NumericQ"}], ",", 
       RowBox[{"phi0_", "?", "NumericQ"}], ",", 
       RowBox[{"phi1_", "?", "NumericQ"}], ",", 
       RowBox[{"gamm_", "?", "NumericQ"}]}], "}"}], ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
      "ppm", ",", "specF", ",", "specBasisF", ",", "metBasis", ",", "basis", 
       ",", "fit", ",", "specFit", ",", "spline", ",", "error"}], 
      "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "generate", " ", "basis", " ", "spectra", " ", "from", " ", "time", " ",
        "domain"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"metBasis", "=", 
       RowBox[{"OptionValue", "[", "SpectraMetaboliteBaseline", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"specBasisF", "=", 
       RowBox[{"Transpose", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"ShiftedFourier", "[", 
             RowBox[{"SpectraTimeShift", "[", 
              RowBox[{"timeFull", ",", "#", ",", "gyro", ",", 
               RowBox[{"{", 
                RowBox[{"gam", ",", "eps"}], "}"}]}], "]"}], "]"}], "&"}], "/@",
            "timeBasis"}], ")"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", 
           RowBox[{"indSt", ";;", "indEnd"}]}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"with", " ", "metabolite", " ", "base", " ", "line"}], ",", 
        " ", 
        RowBox[{"done", " ", "perform", " ", "line", " ", "broadning", " ", 
         RowBox[{"metabolites", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"metBasis", "=!=", "None"}], ",", 
        RowBox[{"specBasisF", "=", 
         RowBox[{"Join", "[", 
          RowBox[{"specBasisF", ",", 
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"ShiftedFourier", "[", 
               RowBox[{"SpectraTimeShift", "[", 
                RowBox[{"timeFull", ",", "metBasis", ",", "gyro", ",", 
                 RowBox[{"{", 
                  RowBox[{"gamm", ",", "eps"}], "}"}]}], "]"}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"indSt", ";;", "indEnd"}], "]"}], "]"}], "}"}], "]"}], 
           ",", "2"}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "apply", " ", "phase", " ", "to", " ", "target", " ", "in", " ", 
        "stead", " ", "of", " ", "basis", " ", "functions", " ", 
        RowBox[{"(", "faster", ")"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"specF", "=", 
       RowBox[{"SpectraPhaseShift", "[", 
        RowBox[{"ppmY", ",", "specY", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "phi0"}], ",", 
           RowBox[{"-", "phi1"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"spline", "=", 
       RowBox[{
        RowBox[{"0.", "specF"}], "+", 
        RowBox[{"0.", "I"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "allow", " ", "for", " ", "itterative", " ", "LLS", " ", "fitting"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "perform", " ", "Fit", " ", "of", " ", "basis", " ", "spectra"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"fit", "=", 
          RowBox[{"NNLeastSquares", "[", 
           RowBox[{
            RowBox[{"Re", "[", "specBasisF", "]"}], ",", 
            RowBox[{"Re", "[", 
             RowBox[{"specF", "-", "spline"}], "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"specFit", "=", 
          RowBox[{"specBasisF", ".", "fit"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"perform", " ", "the", " ", "b"}], "-", 
           RowBox[{
           "spline", " ", "fit", " ", "on", " ", "the", " ", "residuals"}]}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"spline", "=", 
          RowBox[{"BSplineCurveFit", "[", 
           RowBox[{
            RowBox[{"specF", "-", "specFit"}], ",", 
            RowBox[{"SplineKnotsNumber", "\[Rule]", " ", "cpn"}], ",", 
            RowBox[{"SplineDegree", "\[Rule]", " ", "2"}], ",", 
            RowBox[{"SplineRegularization", "\[Rule]", "0"}]}], "]"}]}], 
         ";"}], "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"OptionValue", "[", "MaxIterations", "]"}], "}"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"give", " ", "ouput"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Switch", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "Output", "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"output", " ", "error", " ", "of", " ", "fit"}], "*)"}], 
        "\[IndentingNewLine]", "\"\<Error\>\"", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"error", "=", 
          RowBox[{"specF", "-", "specFit", "-", "spline"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Total", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"Re", "[", "error", "]"}], ")"}], "^", "2"}], "]"}], "+", 
          RowBox[{"Total", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"Im", "[", "error", "]"}], ")"}], "^", "2"}], "]"}]}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"ouput", " ", "the", " ", "fit", " ", "results"}], "*)"}], 
        "\[IndentingNewLine]", "\"\<Fit\>\"", ",", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "apply", " ", "phase", " ", "to", " ", "the", " ", "basis", " ", 
          "spectra", " ", "and", " ", "spline"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"spline", "=", 
          RowBox[{"SpectraPhaseShift", "[", 
           RowBox[{"ppmY", ",", "spline", ",", 
            RowBox[{"{", 
             RowBox[{"phi0", ",", "phi1"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"specBasisF", "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"SpectraPhaseShift", "[", 
              RowBox[{"ppmY", ",", "#", ",", 
               RowBox[{"{", 
                RowBox[{"phi0", ",", "phi1"}], "}"}]}], "]"}], "&"}], "/@", 
            RowBox[{"Transpose", "[", "specBasisF", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"specFit", "=", 
          RowBox[{"specBasisF", ".", "fit"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"specFit", ",", "spline", ",", "fit", ",", "specBasisF"}], 
          "}"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Clear", "[", "FitSpectra", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FitSpectra", "]"}], "=", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SpectraNucleus", "\[Rule]", "\"\<1H\>\""}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"SpectraPPMShift", "\[Rule]", "4.65"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"SpectraFieldStrength", "\[Rule]", "7"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"SpectraPaddingFactor", "\[Rule]", "1"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"SpectraSplineSpacingFactor", "\[Rule]", "1.5"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"MaxIterations", "\[Rule]", "3"}], ",", "\[IndentingNewLine]", 
      RowBox[{"SpectraMetaboliteBaseline", "\[Rule]", "None"}]}], 
     "\[IndentingNewLine]", "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FitSpectra", "[", 
   RowBox[{"specBasisIn_", ",", "specIn_", ",", 
    RowBox[{"{", 
     RowBox[{"st_", ",", "end_"}], "}"}], ",", "dtime_", ",", 
    RowBox[{"{", 
     RowBox[{"lwvals_", ",", "lwamsp_"}], "}"}], ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "t1", ",", "pad", ",", "spfac", ",", " ", "specYFull", ",", "field", ",",
       "nuc", ",", "shift", ",", "\[IndentingNewLine]", "timeBasis", ",", 
      "metBasis", ",", "timeFull", ",", "ppmFull", ",", "nsamp", ",", "ppmFr",
       ",", "\[IndentingNewLine]", "indSt", ",", "indEnd", ",", "specY", ",", 
      "times", ",", "ppms", ",", "\[IndentingNewLine]", "specYP", ",", 
      "phi0i", ",", "phi1i", ",", "gamf", ",", "epsf", ",", "phi0f", ",", 
      "phi1f", ",", "\[IndentingNewLine]", "lw", ",", "epsi", ",", 
      "splineSpace", ",", "gami", ",", "cpn", ",", "gamm", ",", "gammf", ",", 
      "\[IndentingNewLine]", "gam", ",", "eps", ",", "gam1", ",", "eps1", ",",
       "phi0", ",", "phi1", ",", "full", ",", "tar", ",", "par", ",", "ran", 
      ",", "err", ",", "sol", ",", "\[IndentingNewLine]", "specFit", ",", 
      "spline", ",", "specBasisF", ",", "fit", ",", "output", ",", "log", ",",
       "\[IndentingNewLine]", "splineFit", ",", "parFit", ",", "specBasis", 
      ",", "error"}], "\[IndentingNewLine]", "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", "logging", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"log", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"PrintTemporary", "[", 
      RowBox[{"Dynamic", "[", 
       RowBox[{"Column", "[", "log", "]"}], "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"pad", "=", 
      RowBox[{
       RowBox[{"OptionValue", "[", "SpectraPaddingFactor", "]"}], "+", 
       "1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"metBasis", "=", 
      RowBox[{"OptionValue", "[", "SpectraMetaboliteBaseline", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"spfac", "=", 
      RowBox[{"OptionValue", "[", "SpectraSplineSpacingFactor", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"field", "=", " ", 
      RowBox[{"OptionValue", "[", "SpectraFieldStrength", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"nuc", " ", "=", 
      RowBox[{"OptionValue", "[", "SpectraNucleus", "]"}]}], " ", ";", 
     "\[IndentingNewLine]", 
     RowBox[{"shift", " ", "=", " ", 
      RowBox[{"OptionValue", "[", "SpectraPPMShift", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"time", " ", "the", " ", "fitting"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"t1", "=", 
      RowBox[{
       RowBox[{
       "AbsoluteTiming", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "pad", " ", "the", " ", "spectra", " ", "and", " ", "get", " ", 
          "the", " ", "time", " ", "and", " ", "ppm", " ", "axes"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"specYFull", "=", 
          RowBox[{"ShiftedFourier", "[", 
           RowBox[{"PadRight", "[", 
            RowBox[{
             RowBox[{"ShiftedInverseFourier", "[", "specIn", "]"}], ",", 
             RowBox[{"pad", " ", 
              RowBox[{"Length", "[", "specIn", "]"}]}]}], "]"}], "]"}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"timeFull", ",", "ppmFull", ",", 
            RowBox[{"{", 
             RowBox[{"nsamp", ",", "ppmFr"}], "}"}]}], "}"}], "=", 
          RowBox[{"GetTimePPMRange", "[", 
           RowBox[{
           "specYFull", ",", "dtime", ",", "field", ",", "nuc", ",", 
            "shift"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"get", " ", "the", " ", "basis", " ", "spectra"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"timeBasis", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"PadRight", "[", 
             RowBox[{
              RowBox[{"ShiftedInverseFourier", "[", "#", "]"}], ",", 
              RowBox[{"pad", " ", 
               RowBox[{"Length", "[", "#", "]"}]}]}], "]"}], "&"}], "/@", 
           "specBasisIn"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "check", " ", "if", " ", "a", " ", "metabolite", " ", "baseline", 
           " ", "is", " ", "used", " ", "and", " ", "pad"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"metBasis", "=!=", "None"}], ",", 
           RowBox[{"metBasis", "=", 
            RowBox[{"PadRight", "[", 
             RowBox[{
              RowBox[{"ShiftedInverseFourier", "[", "metBasis", "]"}], ",", 
              RowBox[{"pad", " ", 
               RowBox[{"Length", "[", "metBasis", "]"}]}]}], "]"}]}]}], "]"}],
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "find", " ", "the", " ", "positions", " ", "of", " ", "the", " ", 
           "fit", " ", "range"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"indSt", ",", "indEnd"}], "}"}], "=", 
          RowBox[{"Flatten", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Position", "[", 
              RowBox[{"ppmFull", ",", 
               RowBox[{
                RowBox[{"Nearest", "[", 
                 RowBox[{"ppmFull", ",", "#"}], "]"}], "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"st", ",", "end"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"get", " ", "the", " ", "fit", " ", "rance", " ", "data"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"specY", "=", 
          RowBox[{"specYFull", "[", 
           RowBox[{"[", 
            RowBox[{"indSt", ";;", "indEnd"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"times", "=", 
          RowBox[{"timeFull", "[", 
           RowBox[{"[", 
            RowBox[{"indSt", ";;", "indEnd"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"ppms", "=", 
          RowBox[{"ppmFull", "[", 
           RowBox[{"[", 
            RowBox[{"indSt", ";;", "indEnd"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"logging", " ", "of", " ", "input", " ", "parameters"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"Style", "[", 
            RowBox[{"\"\<Spectral Properties\>\"", ",", "Bold"}], "]"}]}], 
          "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - Number of samples:          \>\"", "<>", 
            RowBox[{"ToString", "[", "nsamp", "]"}]}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - Gyro magnetic ratio:        \>\"", "<>", 
            RowBox[{"ToString", "[", "ppmFr", "]"}], "<>", "\"\< Hz\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - Number of fit samples:      \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"indEnd", "-", "indSt", "+", "1"}], "]"}]}]}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", "\"\<\>\""}], "]"}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "find", " ", "initial", " ", "linewidth", " ", "and", " ", "spec", 
           " ", "shift"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"Style", "[", 
            RowBox[{"\"\<Estimating linewidth\>\"", ",", "Bold"}], "]"}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"lw", ",", "epsi"}], "}"}], "=", 
          RowBox[{"EstimateLineWidth", "[", 
           RowBox[{"ppmFull", ",", "specYFull", ",", 
            RowBox[{"{", 
             RowBox[{"lwvals", ",", "lwamsp"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"gami", "=", 
          RowBox[{"ppmFr", " ", "lw"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"logging", " ", "of", " ", "parameters"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - spectral linewidth intit:   \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"gami", " ", "/", "ppmFr"}], "]"}], "<>", 
            "\"\< ppm\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", "gami", "]"}], "<>", "\"\< Hz\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - base spectra shift:         \>\"", "<>", 
            RowBox[{"ToString", "[", "epsi", "]"}], "<>", "\"\< ppm\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"epsi", " ", "ppmFr"}], "]"}], "<>", "\"\< Hz\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", "\"\<\>\""}], "]"}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"find", " ", "initial", " ", "phase", " ", "estimate"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"Style", "[", 
            RowBox[{"\"\<Estimating phase correction\>\"", ",", "Bold"}], 
            "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"phi0i", ",", "phi1i"}], "}"}], "=", 
          RowBox[{"EstimatePhaseShift", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"ppmFull", ",", "specYFull"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"timeFull", ",", "timeBasis"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"gami", ",", "epsi"}], "}"}], ",", "ppmFr"}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"logging", " ", "of", " ", "parameters"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - zeroth order phase:         \>\"", "<>", 
            RowBox[{"ToString", "[", "phi0i", "]"}], "<>", "\"\< rad\>\""}]}],
           "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"phi0i", "/", "Degree"}], "]"}], "<>", 
            "\"\< deg\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - first order phase:          \>\"", "<>", 
            RowBox[{"ToString", "[", "phi1i", "]"}], "<>", 
            "\"\< rad/ppm\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"phi1i", "/", "Degree"}], "]"}], "<>", 
            "\"\< deg/ppm\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", "\"\<\>\""}], "]"}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "get", " ", "the", " ", "spline", " ", "basis", " ", "fucntion", 
           " ", "paramters"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"Style", "[", 
            RowBox[{"\"\<Estimating spline smoothness\>\"", ",", "Bold"}], 
            "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"splineSpace", "=", 
          RowBox[{"spfac", " ", "lw"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"cpn", " ", "=", " ", 
          RowBox[{"Round", "[", 
           RowBox[{
            RowBox[{"Subtract", "@@", 
             RowBox[{"Reverse", "[", 
              RowBox[{"MinMax", "[", "ppms", "]"}], "]"}]}], "/", 
            "splineSpace"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - spline spacing:             \>\"", "<>", 
            RowBox[{"ToString", "[", "splineSpace", "]"}], "<>", 
            "\"\< ppm\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - spline control points:      \>\"", "<>", 
            RowBox[{"ToString", "[", "cpn", "]"}]}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", "\"\<\>\""}], "]"}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{
                    "--", "-"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}\
]}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"perform", " ", "the", " ", "fitting"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"Style", "[", 
            RowBox[{"\"\<Performing spectra fitting\>\"", ",", "Bold"}], 
            "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "get", " ", "the", " ", "input", " ", "for", " ", "the", " ", 
           "fit"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"full", "=", 
          RowBox[{"{", 
           RowBox[{"ppmFull", ",", "timeFull", ",", "timeBasis"}], "}"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"tar", "=", 
          RowBox[{"{", 
           RowBox[{"ppms", ",", "specY"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"ran", "=", 
          RowBox[{"{", 
           RowBox[{"indSt", ",", "indEnd"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"par", "=", 
          RowBox[{"{", 
           RowBox[{"cpn", ",", "ppmFr"}], "}"}]}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"perform", " ", "the", " ", "minimization"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"fit", "=", 
          RowBox[{
           RowBox[{"FindMinimum", "[", 
            RowBox[{
             RowBox[{"{", "\[IndentingNewLine]", 
              RowBox[{"FitBasisSpectraI", "[", 
               RowBox[{"full", ",", "tar", ",", "ran", ",", "par", ",", 
                RowBox[{"{", 
                 RowBox[{
                 "gamf", ",", "epsf", ",", "phi0f", ",", "phi1f", ",", 
                  "gamf"}], "}"}], ",", "\[IndentingNewLine]", 
                RowBox[{"SpectraMetaboliteBaseline", "\[Rule]", "metBasis"}], 
                ",", "\[IndentingNewLine]", 
                RowBox[{"Output", "\[Rule]", "\"\<Error\>\""}], ",", 
                RowBox[{"MaxIterations", "\[Rule]", 
                 RowBox[{"OptionValue", "[", "MaxIterations", "]"}]}]}], 
               "]"}], "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{",", 
                RowBox[{
                 RowBox[{"0.5", "gami"}], "<", "gamf", "<", 
                 RowBox[{"2", "gami"}]}]}], "*)"}], 
              RowBox[{"(*", 
               RowBox[{",", 
                RowBox[{
                 RowBox[{"epsi", "-", ".5"}], "<", "epsf", "<", 
                 RowBox[{"epsi", "+", ".5"}]}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "2"}], "Pi"}], "<", "phi0f", "<", 
                 RowBox[{"2", "Pi"}]}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "2"}], "Pi"}], "<", "phi1f", "<", 
                 RowBox[{"2", "Pi"}]}]}], "*)"}], "}"}], 
             "\[IndentingNewLine]", ",", 
             RowBox[{"{", 
              RowBox[{"gamf", ",", "gami"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"epsf", ",", "epsi"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"phi0f", ",", "phi0i"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"phi1f", ",", "phi1i"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"gammf", ",", "0"}], "}"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Method", "\[Rule]", "\"\<QuasiNewton\>\""}]}], 
            "\[IndentingNewLine]", "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"Print", "[", "fit", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "get", " ", "the", " ", "solution", " ", "and", " ", "output"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"sol", "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"gamf", ",", "epsf", ",", 
               RowBox[{"2", 
                RowBox[{"ArcTan", "[", 
                 RowBox[{"Tan", "[", 
                  RowBox[{"0.5", "phi0f"}], "]"}], "]"}]}], ",", 
               RowBox[{"2", 
                RowBox[{"ArcTan", "[", 
                 RowBox[{"Tan", "[", 
                  RowBox[{"0.5", "phi1f"}], "]"}], "]"}]}], ",", "0"}], "}"}],
              "/.", "fit"}], ")"}], "/.", 
           RowBox[{"{", 
            RowBox[{"gammf", "\[Rule]", "0."}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"gam", ",", "eps", ",", "phi0", ",", "phi1", ",", "gamm"}],
            "}"}], "=", "sol"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"get", " ", "het", " ", "output"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"output", "=", 
          RowBox[{"FitBasisSpectraI", "[", 
           RowBox[{
           "full", ",", "tar", ",", "ran", ",", "par", ",", "sol", ",", 
            "\[IndentingNewLine]", 
            RowBox[{"SpectraMetaboliteBaseline", "\[Rule]", "metBasis"}], ",",
             "\[IndentingNewLine]", 
            RowBox[{"Output", "\[Rule]", "\"\<Fit\>\""}], ",", 
            RowBox[{"MaxIterations", "\[Rule]", 
             RowBox[{"OptionValue", "[", "MaxIterations", "]"}]}]}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", "logging", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - spectral linewidth:         \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"gam", "/", "ppmFr"}], "]"}], "<>", "\"\< ppm\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", "gam", "]"}], "<>", "\"\< Hz\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - base spectra shift:         \>\"", "<>", 
            RowBox[{"ToString", "[", "eps", "]"}], "<>", "\"\< ppm\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"eps", " ", "ppmFr"}], "]"}], "<>", "\"\< Hz\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - zeroth order phase:         \>\"", "<>", 
            RowBox[{"ToString", "[", "phi0", "]"}], "<>", "\"\< rad\>\""}]}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"phi0", "/", "Degree"}], "]"}], "<>", "\"\< deg\>\""}]}],
           "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<    - first order phase:          \>\"", "<>", 
            RowBox[{"ToString", "[", "phi1", "]"}], "<>", 
            "\"\< rad/s\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", 
           RowBox[{"\"\<                                  \>\"", "<>", 
            RowBox[{"ToString", "[", 
             RowBox[{"phi1", "/", "Degree"}], "]"}], "<>", 
            "\"\< deg/s\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"log", ",", "\"\<\>\""}], "]"}], ";"}], 
        "\[IndentingNewLine]", "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"log", " ", "the", " ", "computation", " ", "time"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"log", ",", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Fit performance\>\"", ",", "Bold"}], "]"}]}], "]"}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"log", ",", 
       RowBox[{"\"\<    - Total computation time:     \>\"", "<>", 
        RowBox[{"ToString", "[", "t1", "]"}], "<>", "\"\< s\>\""}]}], "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"Column", "[", "log", "]"}], "]"}], ";"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"specFit", ",", "splineFit", ",", "parFit", ",", "specBasis"}],
        "}"}], "=", "output"}], ";", "\[IndentingNewLine]", 
     RowBox[{"fit", "=", 
      RowBox[{"specBasis", ".", "parFit"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "=", 
      RowBox[{"100", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"specY", "-", 
          RowBox[{"(", 
           RowBox[{"fit", "+", "splineFit"}], ")"}]}], ")"}], "/", 
        RowBox[{"Max", "[", 
         RowBox[{"Abs", "[", "fit", "]"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", 
      RowBox[{
       RowBox[{"ToString", "[", 
        RowBox[{"Round", "[", 
         RowBox[{
          RowBox[{"Abs", "[", 
           RowBox[{"Mean", "[", "error", "]"}], "]"}], ",", ".001"}], "]"}], 
        "]"}], "<>", "\"\< \[PlusMinus] \>\"", "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{"StandardDeviation", "[", "error", "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"log", ",", 
       RowBox[{
       "\"\<    - Residual error (mn \[PlusMinus] std):  \>\"", "<>", "error",
         "<>", "\"\< %\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"give", " ", "the", " ", "output"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"output", ",", 
       RowBox[{"{", 
        RowBox[{"ppms", ",", "specY"}], "}"}], ",", "sol", ",", "log"}], 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7723637675452585`*^9, 3.7723637729130025`*^9}, {
   3.772363803198346*^9, 3.7723638161711516`*^9}, {3.772365226976398*^9, 
   3.772365244669419*^9}, {3.772365311696964*^9, 3.7723653158709183`*^9}, {
   3.772365358527261*^9, 3.7723653748147*^9}, {3.772366016708688*^9, 
   3.772366076146195*^9}, {3.772366198023632*^9, 3.7723662822259045`*^9}, {
   3.772366318308135*^9, 3.77236632601814*^9}, {3.7723663910098095`*^9, 
   3.772366394449483*^9}, 3.7723665097949*^9, {3.7723692923605223`*^9, 
   3.7723693072364063`*^9}, {3.7723695685487976`*^9, 
   3.7723696328304873`*^9}, {3.7723701376574073`*^9, 3.772370365780362*^9}, {
   3.7723705157755632`*^9, 3.7723713448782454`*^9}, 3.7723715076756115`*^9, {
   3.77237155309518*^9, 3.7723717334616165`*^9}, {3.772371764017039*^9, 
   3.772371910843642*^9}, {3.772371952992028*^9, 3.7723720735468435`*^9}, {
   3.772372108782858*^9, 3.77237231834704*^9}, {3.772372407719808*^9, 
   3.77237240983475*^9}, {3.772378054804428*^9, 3.772378091008356*^9}, {
   3.7723781313819537`*^9, 3.7723781323360333`*^9}, {3.7723787882102013`*^9, 
   3.772378796085292*^9}, {3.7723788285251927`*^9, 3.7723788952595525`*^9}, {
   3.772378971084852*^9, 3.772379025496646*^9}, {3.7723795661499877`*^9, 
   3.772379578822342*^9}, {3.772421005098263*^9, 3.7724210054293766`*^9}, {
   3.7724214142747884`*^9, 3.772421575976285*^9}, {3.772421607334821*^9, 
   3.772421619813896*^9}, {3.772421701301941*^9, 3.7724217948745623`*^9}, {
   3.7724218382430573`*^9, 3.7724219588038397`*^9}, {3.772423999449656*^9, 
   3.7724240649252357`*^9}, {3.7724282283013988`*^9, 3.772428525868007*^9}, {
   3.772432563255323*^9, 3.772432585523859*^9}, {3.772432630196384*^9, 
   3.7724326680347166`*^9}, {3.7724327284209647`*^9, 3.772432744442449*^9}, 
   3.77243286024174*^9, {3.7724330412855387`*^9, 3.7724330449012146`*^9}, {
   3.772433096249704*^9, 3.7724331086936693`*^9}, {3.772433172853904*^9, 
   3.772433254659766*^9}, {3.7724342983611517`*^9, 3.772434301419325*^9}, {
   3.7724343436107454`*^9, 3.772434538426059*^9}, {3.772434578380642*^9, 
   3.772434646056146*^9}, {3.772435411576662*^9, 3.7724355064747777`*^9}, {
   3.7724355861235476`*^9, 3.7724355861556025`*^9}, {3.772441554168786*^9, 
   3.7724415688071632`*^9}, {3.772441698471716*^9, 3.7724416994282675`*^9}, 
   3.7724423194849854`*^9, {3.7724432139628487`*^9, 3.772443223898385*^9}, 
   3.772443364954012*^9, {3.772443531193*^9, 3.7724435334974823`*^9}, {
   3.772444654655393*^9, 3.772444728765859*^9}, {3.77244477563406*^9, 
   3.7724448150115137`*^9}, {3.772444964683288*^9, 3.772444964828675*^9}, {
   3.7724452146382055`*^9, 3.7724452528280525`*^9}, {3.7724452845095425`*^9, 
   3.772445319999363*^9}, 3.7724454036783943`*^9, {3.7724455003845263`*^9, 
   3.772445504477411*^9}, {3.772445537596404*^9, 3.7724455376605387`*^9}, 
   3.7724464980246496`*^9, {3.7724469684666176`*^9, 3.7724470039395905`*^9}, {
   3.7724470386636868`*^9, 3.772447130162037*^9}, {3.7724471765166774`*^9, 
   3.7724474586620617`*^9}, 3.772447512498232*^9, {3.772447622902051*^9, 
   3.7724476239558277`*^9}, {3.7724477257999706`*^9, 3.7724477708377705`*^9}, 
   3.772447955470045*^9, {3.772448040068925*^9, 3.7724480464217024`*^9}, {
   3.772448150258566*^9, 3.7724481518441224`*^9}, {3.772448192003024*^9, 
   3.772448209970763*^9}, {3.772448287479273*^9, 3.7724482934121313`*^9}, {
   3.7724483588713093`*^9, 3.7724483956493473`*^9}, {3.772448504025294*^9, 
   3.772448524151482*^9}, {3.7724486149536753`*^9, 3.7724486356055717`*^9}, {
   3.772448815112057*^9, 3.7724488634119453`*^9}, {3.7724489617510586`*^9, 
   3.772448965992014*^9}, {3.7724491936552877`*^9, 3.7724491950290184`*^9}, {
   3.772449240682339*^9, 3.7724492605503855`*^9}, {3.772449389772129*^9, 
   3.772449391014434*^9}, {3.7724494598007975`*^9, 3.7724495630778637`*^9}, {
   3.7724496628956137`*^9, 3.772449667300375*^9}, {3.7724501227649856`*^9, 
   3.772450130796402*^9}, {3.772450422989045*^9, 3.7724505508720694`*^9}, {
   3.772450655613161*^9, 3.772450702416196*^9}, {3.772450855222898*^9, 
   3.772450867147217*^9}, {3.772451101645408*^9, 3.772451154987053*^9}, {
   3.772451185692724*^9, 3.772451346715977*^9}, {3.7724520968612833`*^9, 
   3.7724521052162333`*^9}, {3.7724521520650663`*^9, 3.77245218839783*^9}, {
   3.772452267331769*^9, 3.772452280987153*^9}, {3.7724523869161797`*^9, 
   3.7724524563315334`*^9}, {3.7724560055315385`*^9, 3.772456006167214*^9}, {
   3.7724560891565866`*^9, 3.7724560898654685`*^9}, {3.7724561818641663`*^9, 
   3.772456184627517*^9}, {3.7724563014753776`*^9, 3.772456330457447*^9}, 
   3.7724564712712207`*^9, {3.7724572755334215`*^9, 3.772457276499816*^9}, {
   3.772458189688817*^9, 3.7724582047966228`*^9}, {3.7724582603274326`*^9, 
   3.772458265047517*^9}, {3.772458427391489*^9, 3.772458427992647*^9}, 
   3.772458487456178*^9, {3.7724622025085783`*^9, 3.7724623881360664`*^9}, {
   3.77246242165092*^9, 3.7724624556360283`*^9}, {3.7724625395708637`*^9, 
   3.7724626293699403`*^9}, {3.772462665713132*^9, 3.772462682870737*^9}, 
   3.772462722745303*^9, {3.7724627812760687`*^9, 3.772462808458745*^9}, {
   3.772462875614602*^9, 3.772462892932725*^9}, {3.7724629468541517`*^9, 
   3.7724629775243874`*^9}, {3.77246310056653*^9, 3.772463224056049*^9}, {
   3.7724632648377457`*^9, 3.772463989572025*^9}, {3.772464101184922*^9, 
   3.77246415394757*^9}, {3.7724642290739365`*^9, 3.7724642325198984`*^9}, {
   3.772464323490988*^9, 3.7724643562631054`*^9}, {3.772505812589693*^9, 
   3.7725059403446817`*^9}, {3.7725059724979105`*^9, 
   3.7725059926537943`*^9}, {3.7725060318537183`*^9, 
   3.7725063764813395`*^9}, {3.7725064446494007`*^9, 
   3.7725065400892763`*^9}, {3.7725065923763037`*^9, 
   3.7725067038056145`*^9}, {3.772506748068407*^9, 3.7725067820079865`*^9}, {
   3.7725071419688177`*^9, 3.772507152205482*^9}, {3.7725073045404787`*^9, 
   3.772507304692478*^9}, 3.772507358944382*^9, {3.772507924795843*^9, 
   3.7725079854981933`*^9}, {3.772508031734414*^9, 3.7725080365020027`*^9}, {
   3.7725080815890665`*^9, 3.7725080917629414`*^9}, {3.772508131294567*^9, 
   3.7725081822257977`*^9}, {3.7725082469815817`*^9, 
   3.7725082486988697`*^9}, {3.772508410765155*^9, 3.7725084167357244`*^9}, {
   3.7725085015702868`*^9, 3.7725085225317526`*^9}, {3.772508567931587*^9, 
   3.7725085759425716`*^9}, {3.7725086589559584`*^9, 
   3.7725086597961445`*^9}, {3.772509449286272*^9, 3.772509880226441*^9}, {
   3.7725099265948534`*^9, 3.7725099755935955`*^9}, {3.7725100139608603`*^9, 
   3.772510174184532*^9}, {3.7725102055662303`*^9, 3.7725102252819543`*^9}, 
   3.772510299409638*^9, {3.772510884088751*^9, 3.7725110123231516`*^9}, {
   3.772511087637458*^9, 3.772511158549038*^9}, {3.772511204599236*^9, 
   3.772511215865964*^9}, {3.772511334276867*^9, 3.772511352803195*^9}, 
   3.772511419475651*^9, {3.7725232384519825`*^9, 3.7725232831872835`*^9}, {
   3.772523313840905*^9, 3.7725233735375986`*^9}, {3.772523414180065*^9, 
   3.772523456889541*^9}, {3.7725237924021606`*^9, 3.7725239015699997`*^9}, {
   3.7725239333572307`*^9, 3.772524119412527*^9}, {3.7725241620998964`*^9, 
   3.7725241966605854`*^9}, {3.7725242603237333`*^9, 
   3.7725242608187804`*^9}, {3.7725243114741917`*^9, 3.772524392718867*^9}, {
   3.772524457653078*^9, 3.772524502624712*^9}, {3.772524554674212*^9, 
   3.7725245559263906`*^9}, {3.7725250218124104`*^9, 3.7725250245688148`*^9}, 
   3.772525076528322*^9, {3.7725251464473553`*^9, 3.772525152173538*^9}, {
   3.772525213710002*^9, 3.7725252137571287`*^9}, {3.772525263087562*^9, 
   3.772525300605502*^9}, {3.772525524787508*^9, 3.772525534824712*^9}, {
   3.772525620068295*^9, 3.7725256842161913`*^9}, 3.7725262534355383`*^9, {
   3.7725262853612905`*^9, 3.772526293761858*^9}, {3.7725263339356236`*^9, 
   3.7725264080942583`*^9}, {3.7725264680782595`*^9, 3.772526468159976*^9}, 
   3.7725264989652777`*^9, 3.772526544249633*^9, {3.7725265836374984`*^9, 
   3.7725265836847124`*^9}, {3.772526749795885*^9, 3.772526797983242*^9}, {
   3.7725268874445753`*^9, 3.7725268909150324`*^9}, {3.772526960300975*^9, 
   3.7725270195377216`*^9}, {3.7725270532782364`*^9, 3.772527053718271*^9}, {
   3.772527094364833*^9, 3.7725271393641987`*^9}, {3.7725271829990396`*^9, 
   3.772527200313228*^9}, 3.7725272417240562`*^9, {3.7725272954569864`*^9, 
   3.772527317579533*^9}, {3.772528585450209*^9, 3.7725286635982027`*^9}, {
   3.7725287085499763`*^9, 3.772528736055895*^9}, {3.772528776634861*^9, 
   3.7725288063175297`*^9}, {3.772528856555253*^9, 3.772528875197809*^9}, {
   3.7725289444653053`*^9, 3.772528963945987*^9}, {3.7725290842736826`*^9, 
   3.7725290851507735`*^9}, {3.7725507104170413`*^9, 
   3.7725507464965725`*^9}, {3.772550893605421*^9, 3.7725508955324697`*^9}, 
   3.772551099261724*^9, {3.7725514026680264`*^9, 3.7725515608466997`*^9}, {
   3.7725517196196856`*^9, 3.7725517199947243`*^9}, {3.7725518037114077`*^9, 
   3.7725518040886817`*^9}, {3.772551865287548*^9, 3.7725518749633827`*^9}, {
   3.7726102855787745`*^9, 3.772610320761199*^9}, {3.772610414589583*^9, 
   3.7726104606878624`*^9}, {3.77261344021231*^9, 3.7726134698184433`*^9}, 
   3.7726135439667387`*^9, {3.7726206274136276`*^9, 3.772620652015929*^9}, {
   3.772620686591174*^9, 3.7726207020503054`*^9}, {3.77262078576521*^9, 
   3.7726207994855804`*^9}, 3.772620865165078*^9, {3.77262091881104*^9, 
   3.7726209257864637`*^9}, {3.7726209851104016`*^9, 3.772621018267458*^9}, {
   3.7726210699316406`*^9, 3.772621075368593*^9}, {3.772621771372567*^9, 
   3.772621881365589*^9}, {3.7726219172585435`*^9, 3.772621957147503*^9}, {
   3.7726220728195353`*^9, 3.772622164294259*^9}, 3.772622223862301*^9, {
   3.7726223070573373`*^9, 3.7726223360263057`*^9}, {3.7726223973129215`*^9, 
   3.7726224192794924`*^9}, {3.7726224521514745`*^9, 3.772622465378706*^9}, {
   3.772622637756649*^9, 3.772622646052718*^9}, 3.7726227593322697`*^9, {
   3.7726228166102753`*^9, 3.7726228246265087`*^9}, {3.772622914844636*^9, 
   3.7726229157480083`*^9}, {3.772622959326078*^9, 3.7726229927880845`*^9}, {
   3.772623211468163*^9, 3.77262321588214*^9}, 3.7726232601203933`*^9, 
   3.772623298396333*^9, 3.7726233908462048`*^9, {3.772623774838293*^9, 
   3.772623851972265*^9}, {3.77264370121002*^9, 3.7726437813181057`*^9}, {
   3.772643838032178*^9, 3.772643856173155*^9}, {3.7726439800391235`*^9, 
   3.7726440167044063`*^9}, {3.772644122053567*^9, 3.7726442143691807`*^9}, {
   3.7726443632297497`*^9, 3.7726443637321467`*^9}, {3.77264448588605*^9, 
   3.772644583658063*^9}, 3.7726447502680826`*^9, 3.7726448587456923`*^9, {
   3.772645194201281*^9, 3.772645216521288*^9}, {3.7726453521716037`*^9, 
   3.772645515912449*^9}, 3.772645558790848*^9, {3.7726456248174305`*^9, 
   3.772645652509922*^9}, {3.7726457181967115`*^9, 3.7726457781990476`*^9}, 
   3.7726459080708017`*^9, {3.772645953563699*^9, 3.7726459646950855`*^9}, {
   3.772646251928206*^9, 3.7726462535032263`*^9}, {3.7726463421244206`*^9, 
   3.7726463445982037`*^9}, {3.7726464525077543`*^9, 
   3.7726464633365517`*^9}, {3.772646512790471*^9, 3.7726465134761114`*^9}, {
   3.772646728994235*^9, 3.772646801170188*^9}, {3.772646968105771*^9, 
   3.7726469686004057`*^9}, 3.7726473001784916`*^9, {3.772698386869217*^9, 
   3.7726986551564903`*^9}, {3.772699302487303*^9, 3.772699483915448*^9}, {
   3.772699553174019*^9, 3.772699637971159*^9}, {3.7726996813264065`*^9, 
   3.772699705127883*^9}, {3.772699802597335*^9, 3.7726999676859846`*^9}, {
   3.7726999998972235`*^9, 3.772700120643928*^9}, {3.772700179163072*^9, 
   3.7727001983506184`*^9}, {3.7727002783370304`*^9, 3.772700305013363*^9}, {
   3.7727004359362354`*^9, 3.772700453806507*^9}, {3.7727005712834854`*^9, 
   3.7727006395256186`*^9}, {3.7727006904510794`*^9, 
   3.7727007149982033`*^9}, {3.7727007611826687`*^9, 3.7727007756379805`*^9}, 
   3.7727009243471527`*^9, {3.772701921760933*^9, 3.772701922262824*^9}, {
   3.7727020805201654`*^9, 3.7727020806604347`*^9}, {3.772703229136222*^9, 
   3.772703300116494*^9}, {3.772703352691298*^9, 3.7727033872815356`*^9}, {
   3.7727034824890018`*^9, 3.7727034826449327`*^9}, {3.772703733509794*^9, 
   3.772703733697068*^9}, {3.772704068332899*^9, 3.77270406955918*^9}, 
   3.772704140080815*^9, {3.7727041932594748`*^9, 3.7727042042977505`*^9}, {
   3.7727047740815387`*^9, 3.7727047750775003`*^9}, {3.772704838469578*^9, 
   3.772704866753477*^9}, {3.7727049884648237`*^9, 3.7727049932444754`*^9}, {
   3.7727052205572195`*^9, 3.7727052292491746`*^9}, {3.7727053088053355`*^9, 
   3.772705310450649*^9}, {3.772705367336383*^9, 3.772705440655619*^9}, {
   3.7727054867227774`*^9, 3.772705535472147*^9}, {3.77272809203833*^9, 
   3.7727281205006027`*^9}, {3.772964954042041*^9, 3.7729649645983963`*^9}, {
   3.7729651093648477`*^9, 3.77296511920394*^9}, 3.7729652479433956`*^9, {
   3.772965330710917*^9, 3.772965345668857*^9}, {3.7729791743865805`*^9, 
   3.7729791747905655`*^9}, {3.77298004527586*^9, 3.772980049850026*^9}, {
   3.7729803493644295`*^9, 3.7729803579588623`*^9}, {3.7729804628851876`*^9, 
   3.772980468958683*^9}, {3.7729805009715033`*^9, 3.772980515820922*^9}, {
   3.772980551632875*^9, 3.77298056269576*^9}, {3.7729806176325345`*^9, 
   3.7729806268683*^9}, {3.7729810731827755`*^9, 3.772981074138756*^9}, {
   3.7729812085198774`*^9, 3.772981208807914*^9}, {3.772981280178252*^9, 
   3.772981280590228*^9}, {3.7730210020965147`*^9, 3.773021046806046*^9}, {
   3.77302116361093*^9, 3.773021356339555*^9}, {3.7730214751265554`*^9, 
   3.7730214815155325`*^9}, {3.773021577188613*^9, 3.7730219038132987`*^9}, {
   3.773021944603809*^9, 3.773022019809866*^9}, 3.773023620265125*^9, {
   3.773024775031289*^9, 3.7730250396092954`*^9}, {3.7730250742615595`*^9, 
   3.7730250934124837`*^9}, {3.7730287024358892`*^9, 3.773028729279396*^9}, {
   3.7730327563967853`*^9, 3.7730327974457655`*^9}, {3.7730335585822973`*^9, 
   3.773033559387394*^9}, 3.77303445957973*^9, {3.7730345564151993`*^9, 
   3.773034964699972*^9}, {3.7730362444192305`*^9, 3.7730362554286385`*^9}, 
   3.773037576474558*^9, {3.773037901676692*^9, 3.7730379450233335`*^9}, {
   3.7730383516405444`*^9, 3.773038352055622*^9}, {3.773041309330884*^9, 
   3.773041319458943*^9}, {3.7730413633947334`*^9, 3.773041369072261*^9}, {
   3.7730417644009867`*^9, 3.7730418003053493`*^9}, {3.7730419445338664`*^9, 
   3.7730419461334133`*^9}, {3.7730420117185345`*^9, 3.773042025445963*^9}, {
   3.7730481886770105`*^9, 3.773048194209347*^9}, {3.7730482885967474`*^9, 
   3.7730482961296153`*^9}, {3.7730539995227823`*^9, 
   3.7730540129265766`*^9}, {3.773054051027762*^9, 3.7730540647218437`*^9}, 
   3.773054486166935*^9, {3.773055215101445*^9, 3.7730552280546536`*^9}, {
   3.7731104556687183`*^9, 3.773110482922779*^9}, 3.7731105189068403`*^9, {
   3.773110572184589*^9, 3.7731105748281097`*^9}, {3.7731109912603235`*^9, 
   3.773111162702399*^9}, {3.7731111968647985`*^9, 3.7731113033519697`*^9}, {
   3.7731115373557267`*^9, 3.773111556889637*^9}, {3.7731116754601603`*^9, 
   3.7731117042890253`*^9}, {3.7731117384281945`*^9, 3.773111804659411*^9}, 
   3.7731118481965294`*^9, 3.773111889257475*^9, {3.7731120898469906`*^9, 
   3.7731120930461435`*^9}, {3.7731121412256584`*^9, 3.773112269114184*^9}, {
   3.7731123712499695`*^9, 3.773112418929846*^9}, {3.7731125331916704`*^9, 
   3.7731125375642858`*^9}, {3.7731125823724403`*^9, 
   3.7731126075674653`*^9}, {3.7731128256631126`*^9, 
   3.7731130676978455`*^9}, {3.773113124987894*^9, 3.7731132993063726`*^9}, {
   3.7731133994564915`*^9, 3.7731134694248123`*^9}, 3.77311533273632*^9, 
   3.7731153899136715`*^9, {3.7731154595119877`*^9, 3.773115461159793*^9}, {
   3.7731155390123405`*^9, 3.7731155626535015`*^9}, {3.7731156076224813`*^9, 
   3.773115629735667*^9}, {3.773115676298747*^9, 3.773115676375443*^9}, {
   3.773115736285967*^9, 3.77311576984486*^9}, {3.773115803600746*^9, 
   3.7731158081679907`*^9}, 3.77311589214713*^9, {3.7731159938163285`*^9, 
   3.7731160173873158`*^9}, {3.773116142823778*^9, 3.7731163104993467`*^9}, {
   3.773116341034914*^9, 
   3.7731163725690985`*^9}},ExpressionUUID->"2da03b54-2ab5-4bfd-945b-\
2fcc6789c7e0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Ordering raw data", "Subsubsection",
 CellChangeTimes->{{3.772952301714259*^9, 
  3.7729523076076*^9}},ExpressionUUID->"6e5e8f9b-00fa-4d00-90f6-6a5356e04754"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Mean", " ", "over", " ", "list", " ", "of", " ", "values"}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"MeanType", "[", 
     RowBox[{"list_", ",", "type_", ",", "posS_List"}], "]"}], ":=", 
    RowBox[{"Fold", "[", 
     RowBox[{"MeanType", ",", 
      RowBox[{"{", 
       RowBox[{"list", ",", "type"}], "}"}], ",", "posS"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "Mean", " ", "such", " ", "that", " ", "output", " ", "and", " ", "input",
      " ", "match"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"MeanType", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"list_", ",", "type_"}], "}"}], ",", "posS_String"}], "]"}], ":=", 
    RowBox[{"MeanType", "[", 
     RowBox[{"list", ",", "type", ",", "posS"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"single", " ", "evaluation", " ", "of", " ", "mean"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"MeanType", "[", 
     RowBox[{"list_", ",", "type_", ",", "posS_String"}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "pos", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", "type", "]"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pos", "=", 
        RowBox[{"posS", "/.", 
         RowBox[{"Thread", "[", 
          RowBox[{"type", "->", 
           RowBox[{"Range", "[", 
            RowBox[{"Length", "[", "type", "]"}], "]"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<mean over: \>\"", ",", "posS", ",", "\"\< (\>\"", ",", 
           RowBox[{"pos", "\"\<)\>\""}]}], "]"}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"IntegerQ", "[", "pos", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"MeanAt", "[", 
            RowBox[{"list", ",", "pos"}], "]"}], ",", 
           RowBox[{"Drop", "[", 
            RowBox[{"type", ",", 
             RowBox[{"{", "pos", "}"}]}], "]"}]}], "}"}], ",", "$Failed"}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "calculate", " ", "mean", " ", "at", " ", "specific", " ", "level"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"MeanAt", "[", 
     RowBox[{"list_", ",", "level_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{
      RowBox[{"Total", "[", 
       RowBox[{"list", ",", 
        RowBox[{"{", "level", "}"}]}], "]"}], "/", 
      RowBox[{
       RowBox[{"Dimensions", "[", "list", "]"}], "[", 
       RowBox[{"[", "level", "]"}], "]"}]}], "/;", 
     RowBox[{"1", "\[LessEqual]", 
      RowBox[{"Abs", "[", "level", "]"}], "<=", 
      RowBox[{"ArrayDepth", "@", "list"}]}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"put", " ", "kspace", " ", "in", " ", "requested", " ", "order"}],
     "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OrderKspace", "[", 
     RowBox[{"kspace_", ",", "type_", ",", "order_"}], "]"}], ":=", 
    RowBox[{"OrderKspace", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"kspace", ",", "type"}], "}"}], ",", "order"}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OrderKspace", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"kspace_", ",", "type_"}], "}"}], ",", "order_"}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "mis", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"mis", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"!", 
             RowBox[{"MemberQ", "[", 
              RowBox[{"type", ",", "#"}], "]"}]}], ",", "#", ",", "Nothing"}],
            "]"}], "&"}], "/@", "order"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"mis", "===", 
          RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"kspace", ",", 
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Position", "[", 
                  RowBox[{"order", ",", "#1"}], "]"}], "&"}], ")"}], "/@", 
               "type"}], "]"}]}], "]"}], ",", "order"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Print", "[", 
          RowBox[{
          "\"\<the types \>\"", ",", "mis", ",", "\"\< are missing\>\""}], 
          "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SagitalTranspose", "[", "data_", "]"}], ":=", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Reverse", "[", 
         RowBox[{
          RowBox[{"Transpose", "[", "#1", "]"}], ",", "2"}], "]"}], "&"}], 
       ")"}], "/@", "data"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.772952075552061*^9, 3.7729520759732103`*^9}},
 CellLabel->"In[8]:=",ExpressionUUID->"c1086614-593b-4876-aa74-0b554c05e5e2"]
}, Closed]],

Cell[CellGroupData[{

Cell["Fourier Functions", "Subsubsection",
 CellChangeTimes->{{3.77219478219059*^9, 
  3.7721947871405916`*^9}},ExpressionUUID->"1458e431-bb72-4b43-98f0-\
1bdab7d25876"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "shift", " ", "a", " ", "dataset", " ", "with", " ", "specific", " ", 
    "shifts"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"ShiftData", "[", 
      RowBox[{"data_", ",", "shift_"}], "]"}], ":=", 
     RowBox[{"RotateRight", "[", 
      RowBox[{"data", ",", 
       RowBox[{"Reverse", "[", "shift", "]"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"shift", " ", "data"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"FourierShift", "[", "data_", "]"}], ":=", 
     RowBox[{"RotateRight", "[", 
      RowBox[{"data", ",", 
       RowBox[{"Floor", "[", 
        RowBox[{
         RowBox[{"Dimensions", "[", "data", "]"}], "/", "2"}], "]"}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"InverseFourierShift", "[", "data_", "]"}], ":=", 
     RowBox[{"RotateLeft", "[", 
      RowBox[{"data", ",", 
       RowBox[{"Floor", "[", 
        RowBox[{
         RowBox[{"Dimensions", "[", "data", "]"}], "/", "2"}], "]"}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"perform", " ", "shifted", " ", "fourier"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ShiftedFourier", "[", "time_", "]"}], ":=", 
     RowBox[{"FourierShift", "[", 
      RowBox[{"Fourier", "[", 
       RowBox[{"time", ",", 
        RowBox[{"FourierParameters", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", "1"}], ",", " ", "1"}], "}"}]}]}], "]"}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"FourierShifted", "[", "time_", "]"}], ":=", 
     RowBox[{"Fourier", "[", 
      RowBox[{
       RowBox[{"FourierShift", "[", "time", "]"}], ",", 
       RowBox[{"FourierParameters", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "1"}], ",", " ", "1"}], "}"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ShiftedInverseFourier", "[", "spec_", "]"}], ":=", 
     RowBox[{"InverseFourier", "[", 
      RowBox[{
       RowBox[{"InverseFourierShift", "[", "spec", "]"}], ",", 
       RowBox[{"FourierParameters", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "1"}], ",", " ", "1"}], "}"}]}]}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.7721940139021883`*^9, 3.77219406325373*^9}, {
  3.772194098284117*^9, 3.7721941117145915`*^9}, {3.7721945436019382`*^9, 
  3.7721945720724955`*^9}, {3.772194619416793*^9, 3.772194631712114*^9}, {
  3.772195609794037*^9, 3.7721956214697084`*^9}, {3.7721973748616486`*^9, 
  3.772197378991928*^9}, {3.7729522447851453`*^9, 3.7729522601427155`*^9}, {
  3.7729532140043774`*^9, 3.7729532315061693`*^9}, {3.772956474442197*^9, 
  3.772956475627388*^9}},
 CellLabel->"In[15]:=",ExpressionUUID->"ad7afa91-eed3-415a-bb58-ba1a510918e6"]
}, Closed]],

Cell[CellGroupData[{

Cell["Spectra fourier recon", "Subsubsection",
 CellChangeTimes->{{3.772952002012533*^9, 3.7729520108847036`*^9}, {
  3.772952356719696*^9, 
  3.772952364926444*^9}},ExpressionUUID->"10e1083e-7b72-4abf-b1ce-\
29828290270d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FourierKspace2D", "[", 
    RowBox[{"kspace_", ",", "head_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "ksPad", ",", "dim", ",", "imPad", ",", "shift", ",", "kspaceP", ",", 
       "imData"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"get", " ", "the", " ", "oversampling", " ", "padding"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ksPad", "=", 
       RowBox[{"Round", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\"\<Y-resolution\>\"", ",", "\"\<X-resolution\>\""}], 
              "}"}], 
             RowBox[{"{", 
              RowBox[{
              "\"\<ky_oversample_factor\>\"", ",", 
               "\"\<kx_oversample_factor\>\""}], "}"}]}], "-", 
            RowBox[{"{", 
             RowBox[{"\"\<N_ky\>\"", ",", "\"\<N_samp\>\""}], "}"}]}], ")"}], 
          "/", "2"}], "/.", "head"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "get", " ", "the", " ", "final", " ", "data", " ", "dimentions"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"dim", "=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "\"\<number_of_locations\>\"", ",", "\"\<Y-resolution\>\"", ",", 
          "\"\<X-resolution\>\""}], "}"}], "/.", "head"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "pad", " ", "the", " ", "kaspaces", " ", "with", " ", "zeros"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"kspaceP", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"ArrayPad", "[", 
          RowBox[{"#", ",", 
           RowBox[{"Transpose", "@", 
            RowBox[{"{", 
             RowBox[{"ksPad", ",", "ksPad"}], "}"}]}], ",", 
           RowBox[{"0.", "+", 
            RowBox[{"0.", "I"}]}]}], "]"}], "&"}], "/@", "kspace"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "get", " ", "the", " ", "image", " ", "padding", " ", "and", " ", 
        "image", " ", "shift"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"imPad", "=", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Dimensions", "[", "kspaceP", "]"}], "-", "dim"}], ")"}]}],
         "/", "2"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"shift", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Total", "[", "#", "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\"\<Y_range\>\"", ",", "\"\<X_range\>\""}], "}"}], "/.", 
          "head"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"perform", " ", "the", " ", "fourie", " ", "transform"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"imData", "=", 
       RowBox[{"ArrayPad", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"ShiftData", "[", 
            RowBox[{
             RowBox[{"FourierShifted", "[", "#", "]"}], ",", "shift"}], "]"}],
            "&"}], "/@", "kspaceP"}], ",", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"imPad", ",", "imPad"}], "}"}], "]"}]}], "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FourierKspaceCSI", "[", 
   RowBox[{"kspace_", ",", "head_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "ksPad", ",", "dim", ",", "imPad", ",", "shift", ",", "kspaceP", ",", 
      "imData"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{"get", " ", "the", " ", "oversampling", " ", "padding"}], "*)"}],
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ksPad", "=", 
      RowBox[{"Round", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "\"\<Z-resolution\>\"", ",", "\"\<Y-resolution\>\"", ",", 
              "\"\<X-resolution\>\""}], "}"}], 
            RowBox[{"{", 
             RowBox[{
             "\"\<kz_oversample_factor\>\"", ",", 
              "\"\<ky_oversample_factor\>\"", ",", 
              "\"\<kx_oversample_factor\>\""}], "}"}]}], "-", 
           RowBox[{"{", 
            RowBox[{
            "\"\<N_kz\>\"", ",", "\"\<N_ky\>\"", ",", "\"\<N_kx\>\""}], 
            "}"}]}], ")"}], "/", "2"}], "/.", "head"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "get", " ", "the", " ", "final", " ", "data", " ", "dimentions"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"dim", "=", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "\"\<Z-resolution\>\"", ",", "\"\<Y-resolution\>\"", ",", 
         "\"\<X-resolution\>\""}], "}"}], "/.", "head"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"pad", " ", "the", " ", "kaspaces", " ", "with", " ", "zeros"}],
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{"kspaceP", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"ArrayPad", "[", 
         RowBox[{"#", ",", 
          RowBox[{"Transpose", "@", 
           RowBox[{"{", 
            RowBox[{"ksPad", ",", "ksPad"}], "}"}]}], ",", 
          RowBox[{"0.", "+", 
           RowBox[{"0.", "I"}]}]}], "]"}], "&"}], "/@", "kspace"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "get", " ", "the", " ", "image", " ", "padding", " ", "and", " ", 
       "image", " ", "shift"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"shift", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Total", "[", "#", "]"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
          "\"\<Z_range\>\"", ",", "\"\<Y_range\>\"", ",", "\"\<X_range\>\""}],
           "}"}], "/.", "head"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"perform", " ", "the", " ", "fourie", " ", "transform"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"imData", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"ShiftData", "[", 
         RowBox[{
          RowBox[{"FourierShift", "[", 
           RowBox[{"FourierShifted", "[", "#", "]"}], "]"}], ",", "shift"}], 
         "]"}], "&"}], "/@", "kspaceP"}]}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{
  3.772952552624234*^9, {3.772953255621745*^9, 3.7729532800030065`*^9}, {
   3.7729547629213595`*^9, 3.7729547648233805`*^9}, {3.7729564124759555`*^9, 
   3.772956418618782*^9}},
 CellLabel->"In[21]:=",ExpressionUUID->"775b2077-1a5d-45dc-8de4-df450bc059ed"]
}, Closed]],

Cell[CellGroupData[{

Cell["Spectra data Reconstruction", "Subsubsection",
 CellChangeTimes->{{3.7729523236032896`*^9, 
  3.7729523376133957`*^9}},ExpressionUUID->"0717d4ae-c3bb-4417-a368-\
e9e5d3f50c69"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"CoilWeightedReconCSI", "[", 
    RowBox[{"kspace_", ",", "noisei_", ",", "head_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "CSI", ",", "noise", ",", "CSIsos", ",", "weightsCSI", ",", "sMatC", 
       ",", "nMatC", ",", "csiMat", ",", "dMat", ",", "CSIcc", ",", 
       "spectra"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Switch", "[", 
       RowBox[{
        RowBox[{"ArrayDepth", "[", "kspace", "]"}], ",", 
        "\[IndentingNewLine]", "4", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"CSIcc", "=", 
          RowBox[{"TransData", "[", 
           RowBox[{
            RowBox[{"FourierKspaceCSI", "[", 
             RowBox[{"kspace", ",", "head"}], "]"}], ",", "\"\<l\>\""}], 
           "]"}]}], ";"}], "\[IndentingNewLine]", ",", "5", ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "perform", " ", "spatial", " ", "fourier", " ", "for", " ", "CSI"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"CSI", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"FourierKspaceCSI", "[", 
             RowBox[{"#", ",", "head"}], "]"}], "&"}], "/@", "kspace"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"perfrom", " ", "normalization"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"CSI", "=", 
          RowBox[{"Transpose", "[", "CSI", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"noise", "=", "noisei"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"get", " ", "weights"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"CSIsos", "=", 
          RowBox[{"SumOfSquares", "[", 
           RowBox[{
            RowBox[{"Total", "@", 
             RowBox[{"Abs", "@", "CSI"}]}], ",", 
            RowBox[{"OutputWeights", "\[Rule]", "False"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"weightsCSI", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "/", "CSIsos"}], "&"}], "/@", 
           RowBox[{"CSI", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"perform", " ", "weightd", " ", "reconstruction"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"sMatC", "=", 
          RowBox[{"TransData", "[", 
           RowBox[{"weightsCSI", ",", "\"\<l\>\""}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"nMatC", "=", 
          RowBox[{"Inverse", "[", 
           RowBox[{"NoiseCovariance", "[", "noise", "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"csiMat", "=", 
          RowBox[{"TransData", "[", 
           RowBox[{"CSI", ",", "\"\<l\>\""}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"dMat", "=", 
          RowBox[{"TransData", "[", 
           RowBox[{
            RowBox[{"TransData", "[", 
             RowBox[{
              RowBox[{"Transpose", "[", "CSI", "]"}], ",", "\"\<l\>\""}], 
             "]"}], ",", "\"\<l\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"CSIcc", "=", 
          RowBox[{"MapThread", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Conjugate", "[", "#1", "]"}], ".", "nMatC", ".", 
              "#2"}], "&"}], ",", 
            RowBox[{"{", 
             RowBox[{"sMatC", ",", "dMat"}], "}"}], ",", "3"}], "]"}]}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Perform", " ", "spectral", " ", "Fourier"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"spectra", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FourierShift", "[", 
           RowBox[{"Fourier", "[", 
            RowBox[{"#", ",", 
             RowBox[{"FourierParameters", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"-", "1"}], ",", " ", "1"}], "}"}]}]}], "]"}], "]"}], 
          "&"}], ",", "CSIcc", ",", 
         RowBox[{"{", 
          RowBox[{"-", "2"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Normalize", " ", "spectra"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"spectra", "=", 
       RowBox[{"1000.", 
        RowBox[{"spectra", "/", 
         RowBox[{"Max", "[", 
          RowBox[{"Abs", "[", "spectra", "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"phase", " ", "align", " ", "spectra"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"spectra", "=", 
         RowBox[{"ParallelMap", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"PhaseAlign", "[", "#", "]"}], "&"}], ",", "spectra", ",", 
           RowBox[{"{", "3", "}"}]}], "]"}]}], ";"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"spectra", ",", 
        RowBox[{"TransData", "[", 
         RowBox[{"CSIcc", ",", "\"\<r\>\""}], "]"}]}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CoilWeightedRecon", "[", 
   RowBox[{"kspace_", ",", "noise_", ",", "head_", ",", 
    RowBox[{"shift_:", "0"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "compData", ",", "meanData", ",", "weights", ",", "weightsF", ",", 
      "sMat", ",", "nMat", ",", "dMat", ",", "recon"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{"make", " ", "Image", " ", "Data"}], "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"compData", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"FourierKspace2D", "[", 
          RowBox[{"#", ",", "head"}], "]"}], "&"}], ",", "kspace", ",", 
        RowBox[{"{", 
         RowBox[{"-", "4"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "shift", " ", "the", " ", "echos", " ", "to", " ", "center", " ", "if", 
       " ", "needed"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"shift", "=!=", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"compData", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"EvenQ", "[", "i", "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{"RotateRight", "[", 
              RowBox[{
               RowBox[{"compData", "[", 
                RowBox[{"[", "i", "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"0", ",", "0", ",", "0", ",", 
                 RowBox[{"shift", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RotateLeft", "[", 
              RowBox[{
               RowBox[{"compData", "[", 
                RowBox[{"[", "i", "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"0", ",", "0", ",", "0", ",", 
                 RowBox[{"shift", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}]}], 
            "\[IndentingNewLine]", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", 
             RowBox[{"Length", "[", "compData", "]"}]}], "}"}]}], "]"}]}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "calculate", " ", "mean", " ", "signal", " ", "and", " ", "complex", 
       " ", "coil", " ", "weights"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Switch", "[", 
      RowBox[{
       RowBox[{"ArrayDepth", "[", "compData", "]"}], ",", 
       "\[IndentingNewLine]", "4", ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Calculate", " ", "the", " ", "mean", " ", "abs", " ", "signal", " ", 
         "and", " ", "determine", " ", "the", " ", "weights"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"meanData", "=", 
         RowBox[{"SumOfSquares", "[", 
          RowBox[{
           RowBox[{"Abs", "@", "compData"}], ",", 
           RowBox[{"OutputWeights", "\[Rule]", "False"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"weights", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "/", "meanData"}], "&"}], ",", "compData"}], "]"}]}],
         ";"}], "\[IndentingNewLine]", ",", "5", ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Calculate", " ", "the", " ", "mean", " ", "abs", " ", "signal", " ", 
         "of", " ", "the", " ", "first", " ", "echo", " ", "and", " ", 
         "determine", " ", "the", " ", "weights"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"meanData", "=", 
         RowBox[{"SumOfSquares", "[", 
          RowBox[{
           RowBox[{"Abs", "@", 
            RowBox[{"compData", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], ",", 
           RowBox[{"OutputWeights", "\[Rule]", "False"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"weights", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "/", "meanData"}], "&"}], ",", 
           RowBox[{"compData", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"filter", " ", "weights"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"weightsF", "=", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"MedianFilter", "[", 
           RowBox[{
            RowBox[{"Re", "[", "#", "]"}], ",", "1"}], "]"}], "+", 
          RowBox[{"I", " ", 
           RowBox[{"MedianFilter", "[", 
            RowBox[{
             RowBox[{"Im", "[", "#", "]"}], ",", "1"}], "]"}]}]}], "&"}], ",",
         "weights", ",", 
        RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"perform", " ", "reconstruction"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"sMat", "=", 
      RowBox[{"TransData", "[", 
       RowBox[{"weightsF", ",", "\"\<l\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"nMat", "=", 
      RowBox[{"Inverse", "[", 
       RowBox[{"NoiseCovariance", "[", "noise", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"recon", "=", 
      RowBox[{"Switch", "[", 
       RowBox[{
        RowBox[{"ArrayDepth", "[", "compData", "]"}], ",", 
        "\[IndentingNewLine]", "4", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dMat", "=", 
          RowBox[{"TransData", "[", 
           RowBox[{"compData", ",", "\"\<l\>\""}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Conjugate", "[", "#1", "]"}], ".", "nMat", ".", "#2"}], 
            "&"}], ",", 
           RowBox[{"{", 
            RowBox[{"sMat", ",", "dMat"}], "}"}], ",", "3"}], "]"}]}], 
        "\[IndentingNewLine]", ",", "5", ",", "\[IndentingNewLine]", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"dMat", "=", 
              RowBox[{"TransData", "[", 
               RowBox[{"#", ",", "\"\<l\>\""}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"MapThread", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"Conjugate", "[", "#1", "]"}], ".", "nMat", ".", 
                 "#2"}], "&"}], ",", 
               RowBox[{"{", 
                RowBox[{"sMat", ",", "dMat"}], "}"}], ",", "3"}], "]"}]}], 
            "\[IndentingNewLine]", ")"}], "&"}], "/@", "compData"}], "]"}]}], 
       "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"scale", " ", "to", " ", "proper", " ", "values"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"recon", "=", 
      RowBox[{"1000.", 
       RowBox[{"recon", "/", 
        RowBox[{"Max", "[", 
         RowBox[{"Abs", "[", "recon", "]"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "[", "recon", "]"}], "&"}], "/@", 
      RowBox[{"{", 
       RowBox[{"Abs", ",", "Arg", ",", "Re", ",", "Im"}], "}"}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.772952131746009*^9, 3.7729521362724056`*^9}},
 CellLabel->"In[23]:=",ExpressionUUID->"56c31631-f92c-4e6c-be99-ab187a0aa9b0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"MakeSpectraGrid", "[", 
   RowBox[{"spectra_", ",", 
    RowBox[{"sc_:", "0.025"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"spectraF", ",", "max", ",", "plots", ",", "speci"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"spectraF", "=", 
      RowBox[{"ParallelMap", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"GaussianFilter", "[", 
          RowBox[{
           RowBox[{"Abs", "[", "#", "]"}], ",", "2"}], "]"}], "&"}], ",", 
        "spectra", ",", 
        RowBox[{"{", 
         RowBox[{"-", "2"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"max", "=", 
      RowBox[{"Max", "[", "spectraF", "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"plots", "=", 
      RowBox[{"ParallelMap", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"(", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"speci", "=", 
            RowBox[{"#", "-", 
             RowBox[{"Min", "[", "#", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Max", "[", "#", "]"}], ">", 
              RowBox[{"sc", " ", "max"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"ListLinePlot", "[", 
              RowBox[{"speci", ",", 
               RowBox[{"PlotRange", "\[Rule]", 
                RowBox[{"{", 
                 RowBox[{"0", ",", 
                  RowBox[{"0.5", "max"}]}], "}"}]}], ",", 
               RowBox[{"Axes", "\[Rule]", "False"}], ",", 
               RowBox[{"ImageSize", "\[Rule]", "50"}], ",", 
               RowBox[{"AspectRatio", "\[Rule]", "1"}], ",", 
               RowBox[{"PlotStyle", "\[Rule]", 
                RowBox[{"Directive", "[", 
                 RowBox[{"{", 
                  RowBox[{"Thick", ",", 
                   RowBox[{"Darker", "@", "Green"}]}], "}"}], "]"}]}], ",", 
               RowBox[{"PerformanceGoal", "\[Rule]", "\"\<Quality\>\""}]}], 
              "]"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
             RowBox[{"ListLinePlot", "[", 
              RowBox[{"speci", ",", 
               RowBox[{"PlotRange", "\[Rule]", 
                RowBox[{"{", 
                 RowBox[{"0", ",", 
                  RowBox[{"0.5", "max"}]}], "}"}]}], ",", 
               RowBox[{"Axes", "\[Rule]", "False"}], ",", 
               RowBox[{"ImageSize", "\[Rule]", "50"}], ",", 
               RowBox[{"AspectRatio", "\[Rule]", "1"}], ",", 
               RowBox[{"PlotStyle", "\[Rule]", 
                RowBox[{"Directive", "[", 
                 RowBox[{"{", 
                  RowBox[{"Thick", ",", 
                   RowBox[{"Darker", "@", "Red"}]}], "}"}], "]"}]}], ",", 
               RowBox[{"PerformanceGoal", "\[Rule]", "\"\<Speed\>\""}]}], 
              "]"}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
          ")"}], "&"}], ",", "spectraF", ",", 
        RowBox[{"{", 
         RowBox[{"-", "2"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Grid", "[", 
        RowBox[{"#", ",", 
         RowBox[{"Spacings", "\[Rule]", "0"}]}], "]"}], "&"}], "/@", 
      "plots"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{3.7729521646567216`*^9},
 CellLabel->"In[25]:=",ExpressionUUID->"897c8227-96bf-4bff-9f88-a77a17e32cac"]
}, Closed]],

Cell[CellGroupData[{

Cell["Read List Data", "Subsubsection",
 CellChangeTimes->{{3.7729517793434763`*^9, 
  3.7729517841474934`*^9}},ExpressionUUID->"a13fb7bd-c93c-4b9c-93e2-\
bfefabc06531"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ReadListData", "[", "file_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "fl", ",", "head", ",", "list", ",", "data", ",", "lab", ",", 
      "dataIndex", ",", "dataVals", ",", "dataValsN", ",", "ruleKx", ",", 
      "ruleKy", ",", "ruleKz", ",", "ruleCoil", ",", "\[IndentingNewLine]", 
      "typ", ",", "pos", ",", "dataSplit", ",", "indexSplit", ",", " ", 
      "echo", ",", "\[IndentingNewLine]", "sizeInd", ",", "size", ",", "ind", 
      ",", "off", ",", "noise", ",", "indData", ",", "nSamp", ",", "kspace", 
      ",", "line", ",", "types", ",", "outData", ",", "outHead"}], "}"}], ",",
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"fl", "=", 
      RowBox[{"StringReplace", "[", 
       RowBox[{"file", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\<.list\>\"", "\[Rule]", "\"\<\>\""}], ",", 
          RowBox[{"\"\<.data\>\"", "\[Rule]", "\"\<\>\""}]}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"!", 
         RowBox[{"FileExistsQ", "[", 
          RowBox[{"fl", "<>", "\"\<.list\>\""}], "]"}]}], "||", 
        RowBox[{"!", 
         RowBox[{"FileExistsQ", "[", 
          RowBox[{"fl", "<>", "\"\<.data\>\""}], "]"}]}]}], ",", 
       RowBox[{"Print", "[", "\"\<files not found\>\"", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"read", " ", "the", " ", "data"}], " ", "-", " ", 
       RowBox[{"longest", " ", "part"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"list", "=", 
      RowBox[{"ReadList", "[", 
       RowBox[{
        RowBox[{"fl", "<>", "\"\<.list\>\""}], ",", "String"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"data", "=", 
      RowBox[{"BinaryReadList", "[", 
       RowBox[{
        RowBox[{"fl", "<>", "\"\<.data\>\""}], ",", "\"\<Complex64\>\""}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"Get", " ", "the", " ", "header"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"head", "=", 
      RowBox[{"StringSplit", "/@", 
       RowBox[{"Select", "[", 
        RowBox[{"list", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"StringTake", "[", 
            RowBox[{"#", ",", "1"}], "]"}], "===", "\"\<.\>\""}], "&"}]}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"head", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{"head", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "5"}], "]"}], "]"}], "\[Rule]", 
        RowBox[{"ToExpression", "[", 
         RowBox[{"head", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", 
            RowBox[{"7", ";;"}]}], "]"}], "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"head", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "#", "]"}], "\[Equal]", "1"}], ",", 
          RowBox[{"#", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "#"}], "]"}], "&"}], "/@", 
       RowBox[{"head", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"get", " ", "the", " ", "labels"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"lab", "=", 
      RowBox[{
       RowBox[{"StringSplit", "[", 
        RowBox[{"list", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{
            RowBox[{"StringPosition", "[", 
             RowBox[{
              RowBox[{"StringJoin", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"StringTake", "[", 
                  RowBox[{"#", ",", "1"}], "]"}], "&"}], "/@", "list"}], 
               "]"}], ",", "\"\<# \>\""}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "-", "2"}], "]"}], "]"}], 
        "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"2", ";;", 
         RowBox[{"-", "2"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"parse", " ", "text", " ", "table"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"dataIndex", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"StringSplitExp", "[", 
        RowBox[{"Select", "[", 
         RowBox[{"list", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"StringTake", "[", 
             RowBox[{"#", ",", "1"}], "]"}], "===", "\"\< \>\""}], "&"}]}], 
         "]"}], "]"}], "]"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"longest", " ", "part"}], "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"create", " ", "header", " ", "values"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"dataVals", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{"lab", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Sort", "[", 
            RowBox[{"DeleteDuplicates", "[", "#", "]"}], "]"}], "&"}], "/@", 
          "dataIndex"}], ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dataValsN", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"\"\<N_\>\"", "<>", "#"}], "&"}], "/@", 
         RowBox[{"dataVals", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "\[Rule]", 
        RowBox[{"Length", "/@", 
         RowBox[{"dataVals", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], " ", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dataVals", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "#", "]"}], "\[Equal]", "1"}], ",", 
          RowBox[{"#", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "#"}], "]"}], "&"}], "/@", 
       RowBox[{"dataVals", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Create", " ", "rules", " ", "for", " ", "values", " ", "that", " ", 
       "are", " ", "not", " ", "a", " ", "normal", " ", 
       RowBox[{"range", ".", " ", "eg"}], " ", "kspace", " ", "index", " ", 
       "or", " ", "coil", " ", "numbers"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"MemberQ", "[", 
        RowBox[{"lab", ",", "\"\<kx\>\""}], "]"}], ",", 
       RowBox[{"ruleKx", "=", 
        RowBox[{"Thread", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"\"\<kx\>\"", "/.", "dataVals"}], ")"}], "\[Rule]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Range", "[", 
             RowBox[{"\"\<N_kx\>\"", "/.", "dataValsN"}], "]"}], "-", "1"}], 
           ")"}]}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"ruleKy", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"\"\<ky\>\"", "/.", "dataVals"}], ")"}], "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"\"\<N_ky\>\"", "/.", "dataValsN"}], "]"}], "-", "1"}], 
         ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"ruleKz", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"\"\<kz\>\"", "/.", "dataVals"}], ")"}], "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"\"\<N_kz\>\"", "/.", "dataValsN"}], "]"}], "-", "1"}], 
         ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"ruleCoil", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"\"\<chan\>\"", "/.", "dataVals"}], ")"}], "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"\"\<N_chan\>\"", "/.", "dataValsN"}], "]"}], "-", "1"}], 
         ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"partition", " ", "raw", " ", "data", " ", "per", " ", "k"}], 
       "-", "line"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"data", "=", 
      RowBox[{"DynamicPartition", "[", 
       RowBox[{"data", ",", 
        RowBox[{
         RowBox[{"dataIndex", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}], "/", "8"}]}], "]"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"longest", " ", "part"}], "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "split", " ", "the", " ", "data", " ", "and", " ", "index", " ", "for", 
       " ", "data", " ", "type"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"typ", "=", 
      RowBox[{"(", 
       RowBox[{"\"\<typ\>\"", "/.", 
        RowBox[{"dataVals", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"pos", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "@", 
         RowBox[{"Position", "[", 
          RowBox[{
           RowBox[{"dataIndex", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", "#"}], "]"}]}], "&"}], "/@", 
       "typ"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dataSplit", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{"typ", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"data", "[", 
            RowBox[{"[", "#", "]"}], "]"}], "&"}], "/@", "pos"}], ")"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"indexSplit", "=", 
      RowBox[{"Thread", "[", 
       RowBox[{"typ", "\[Rule]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"dataIndex", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "#"}], "]"}], "]"}], "&"}], "/@", "pos"}], 
         ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "get", " ", "the", " ", "number", " ", "of", " ", "sample", " ", "in", 
       " ", "the", " ", "data", " ", "data"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"nSamp", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"\"\<STD\>\"", "/.", "indexSplit"}], ")"}], "[", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "1"}], "]"}], "]"}], "/", "8"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"dataValsN", ",", 
       RowBox[{"\"\<N_samp\>\"", "\[Rule]", "nSamp"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"get", " ", "the", " ", "data", " ", "size"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"sizeInd", "=", 
      RowBox[{"{", 
       RowBox[{
       "\"\<N_kx\>\"", ",", "\"\<N_ky\>\"", ",", "\"\<N_kz\>\"", ",", 
        "\"\<N_chan\>\"", ",", "\"\<N_dyn\>\"", ",", "\"\<N_card\>\"", ",", 
        "\"\<N_echo\>\"", ",", "\"\<N_loca\>\"", ",", "\"\<N_mix\>\"", ",", 
        "\"\<N_extr1\>\"", ",", "\"\<N_extr2\>\"", ",", "\"\<N_aver\>\"", 
        ",", "\"\<N_samp\>\""}], "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"sizeInd", "=", 
      RowBox[{"Select", "[", 
       RowBox[{"sizeInd", ",", 
        RowBox[{
         RowBox[{"MemberQ", "[", 
          RowBox[{
           RowBox[{"dataValsN", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "#"}], "]"}], 
         "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"size", "=", 
      RowBox[{"sizeInd", "/.", "dataValsN"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{
       "get", " ", "the", " ", "types", " ", "with", " ", "dimensions"}], " ",
        ">", " ", "1"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"types", "=", 
      RowBox[{"Pick", "[", 
       RowBox[{"sizeInd", ",", 
        RowBox[{"Unitize", "[", 
         RowBox[{"size", "-", "1"}], "]"}], ",", "1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"process", " ", "noise", " ", "data"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"noise", "=", 
      RowBox[{"\"\<NOI\>\"", "/.", "dataSplit"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "get", " ", "acepterd", " ", "sample", " ", "data", " ", "and", " ", 
       "index"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"data", "=", 
      RowBox[{"(", 
       RowBox[{"\"\<STD\>\"", "/.", "dataSplit"}], ")"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ind", "=", 
      RowBox[{
       RowBox[{"sizeInd", "[", 
        RowBox[{"[", 
         RowBox[{";;", 
          RowBox[{"-", "2"}]}], "]"}], "]"}], "/.", 
       RowBox[{"Thread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"\"\<N_\>\"", "<>", "#"}], "&"}], "/@", "lab"}], "->", 
         RowBox[{"Range", "[", 
          RowBox[{"Length", "[", "lab", "]"}], "]"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"indData", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"\"\<STD\>\"", "/.", "indexSplit"}], ")"}], "[", 
       RowBox[{"[", "ind", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"reverse", " ", "even", " ", "echo"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"echo", "=", 
      RowBox[{"1", "-", 
       RowBox[{"Mod", "[", 
        RowBox[{
         RowBox[{"indData", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"Position", "[", 
             RowBox[{"sizeInd", ",", "\"\<N_echo\>\""}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ",", "2"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"data", "=", 
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"#2", "\[Equal]", "0"}], ",", 
           RowBox[{"Reverse", "@", "#"}], ",", "#"}], "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{"data", ",", "echo"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "convert", " ", "the", " ", "index", " ", "values", " ", "to", " ", 
       "array", " ", "values"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"off", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MemberQ", "[", 
         RowBox[{"lab", ",", "\"\<kx\>\""}], "]"}], ",", "1", ",", "0"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"MemberQ", "[", 
        RowBox[{"lab", ",", "\"\<kx\>\""}], "]"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"indData", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "=", 
         RowBox[{
          RowBox[{"indData", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "/.", "ruleKx"}]}], ";"}]}], "]"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"indData", "[", 
       RowBox[{"[", 
        RowBox[{"1", "+", "off"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"indData", "[", 
        RowBox[{"[", 
         RowBox[{"1", "+", "off"}], "]"}], "]"}], "/.", "ruleKy"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"indData", "[", 
       RowBox[{"[", 
        RowBox[{"2", "+", "off"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"indData", "[", 
        RowBox[{"[", 
         RowBox[{"2", "+", "off"}], "]"}], "]"}], "/.", "ruleKz"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"indData", "[", 
       RowBox[{"[", 
        RowBox[{"3", "+", "off"}], "]"}], "]"}], "=", 
      RowBox[{
       RowBox[{"indData", "[", 
        RowBox[{"[", 
         RowBox[{"3", "+", "off"}], "]"}], "]"}], "/.", "ruleCoil"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"indData", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"indData", "+", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"create", " ", "squeezed", " ", "k"}], "-", "space"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "line", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"kspace", "=", 
      RowBox[{"ReplacePart", "[", 
       RowBox[{
        RowBox[{"ConstantArray", "[", 
         RowBox[{"line", ",", 
          RowBox[{"size", "[", 
           RowBox[{"[", 
            RowBox[{";;", 
             RowBox[{"-", "2"}]}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"Thread", "[", 
         RowBox[{"indData", "\[Rule]", "data"}], "]"}]}], "]"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"longest", " ", "part"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"line", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{
        RowBox[{"0.", "+", 
         RowBox[{"0.", "I"}]}], ",", "nSamp"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"kspace", "=", 
      RowBox[{"Squeeze", "[", "kspace", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"size", "=", 
      RowBox[{"Dimensions", "[", "kspace", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "line", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"print", " ", "output"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Print", "[", 
      RowBox[{"\"\<Datatypes in data: \>\"", ",", 
       RowBox[{"(", 
        RowBox[{"\"\<typ\>\"", "/.", 
         RowBox[{"dataVals", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], ")"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", 
      RowBox[{"Column", "[", 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"StringJoin", "/@", 
          RowBox[{"Thread", "[", 
           RowBox[{"{", 
            RowBox[{"\"\<  - \>\"", ",", "types", ",", "\"\<: \>\"", ",", 
             RowBox[{"ToString", "/@", "size"}]}], "}"}], "]"}]}], ",", 
         "\"\<The data contains: \>\""}], "]"}], "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"define", " ", "output"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"outHead", "=", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Join", "[", 
         RowBox[{"dataVals", ",", "dataValsN", ",", "head"}], "]"}], ",", 
        "types"}], "}"}]}], ";", 
     RowBox[{"(*", "General", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"outData", "=", 
      RowBox[{"{", 
       RowBox[{"kspace", ",", "noise"}], "}"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "output", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"outData", ",", "outHead"}], "}"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellLabel->"In[26]:=",ExpressionUUID->"ecd69e73-ae79-4f1a-bd6b-8479fc5ecdad"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "split", " ", "string", " ", "en", " ", "convert", " ", "to", " ", 
    "expression"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"StringSplitExp", "[", "strings_", "]"}], ":=", 
    RowBox[{"System`Convert`TableDump`ParseTable", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"StringCases", "[", 
        RowBox[{"strings", ",", 
         RowBox[{
          RowBox[{"Except", "[", "WhitespaceCharacter", "]"}], ".."}]}], 
        "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{";;", 
          RowBox[{"-", "2"}]}]}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\"\<\>\"", ",", "\"\<\>\""}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"\"\<-\>\"", ",", "\"\<+\>\""}], "}"}], ",", "\"\<.\>\""}], 
       "}"}], ",", "False"}], "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"removes", " ", "singleton", " ", "dimensions"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Squeeze", "[", "data_", "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "single", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"single", "=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"Unitize", "[", 
             RowBox[{
              RowBox[{"Dimensions", "[", "data", "]"}], "-", "1"}], "]"}]}], 
           ")"}], "/.", " ", 
          RowBox[{"0", "\[Rule]", "All"}]}], ")"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"single", "[", 
            RowBox[{"[", 
             RowBox[{"-", "1"}], "]"}], "]"}], "===", "All"}], "&&", 
          RowBox[{
           RowBox[{"Length", "[", "single", "]"}], ">", "1"}]}], ",", 
         RowBox[{"single", "=", 
          RowBox[{"Drop", "[", 
           RowBox[{"single", ",", 
            RowBox[{"-", "1"}]}], "]"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ToPackedArray", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"data", "[", 
           RowBox[{"[", "##", "]"}], "]"}], "&"}], "@@", "single"}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "partition", " ", "data", " ", "in", " ", "lists", " ", "of", " ", 
     "arbitrary", " ", "length"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"DynamicPartition", "[", 
     RowBox[{"L_", ",", 
      RowBox[{"p", ":", 
       RowBox[{"{", "__Integer", "}"}]}], ",", "x___"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"dPcore", "[", 
      RowBox[{"L", ",", 
       RowBox[{"Accumulate", "@", "p"}], ",", "x"}], "]"}], "/;", 
     RowBox[{
      RowBox[{"!", 
       RowBox[{"Negative", "@", 
        RowBox[{"Min", "@", "p"}]}]}], "&&", 
      RowBox[{
       RowBox[{"Length", "@", "L"}], "\[GreaterEqual]", 
       RowBox[{"Tr", "@", "p"}]}]}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Partition", " ", "function"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dPcore", "[", 
     RowBox[{"L_", ",", 
      RowBox[{"p", ":", 
       RowBox[{"{", 
        RowBox[{"q___", ",", "_"}], "}"}]}]}], "]"}], ":=", 
    RowBox[{"Inner", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"L", "[", 
        RowBox[{"[", 
         RowBox[{"#", ";;", "#2"}], "]"}], "]"}], "&"}], ",", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"0", ",", "q"}], "}"}], "+", "1"}], ",", "p", ",", 
      RowBox[{"Head", "@", "L"}]}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dPcore", "[", 
     RowBox[{"L_", ",", "p_", ",", "All"}], "]"}], ":=", 
    RowBox[{"Append", "[", 
     RowBox[{
      RowBox[{"dPcore", "[", 
       RowBox[{"L", ",", "p"}], "]"}], ",", 
      RowBox[{"Drop", "[", 
       RowBox[{"L", ",", 
        RowBox[{"Last", "@", "p"}]}], "]"}]}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{"dPcore", "[", 
     RowBox[{"L_", ",", "p_", ",", "n__"}], "]"}], ":=", 
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"dPcore", "[", 
       RowBox[{"L", ",", "p"}], "]"}], ",", 
      RowBox[{"Partition", "[", 
       RowBox[{
        RowBox[{"Drop", "[", 
         RowBox[{"L", ",", 
          RowBox[{"Last", "@", "p"}]}], "]"}], ",", "n"}], "]"}]}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.7729518336626587`*^9, 3.77295183535818*^9}},
 CellLabel->"In[27]:=",ExpressionUUID->"a48c84e2-fa99-458a-b826-bbadfb8c5d99"]
}, Closed]],

Cell[CellGroupData[{

Cell["Export PDF report", "Subsubsection",
 CellChangeTimes->{{3.7726983620660315`*^9, 
  3.772698371512529*^9}},ExpressionUUID->"cc74f5d7-4d95-4ad7-a5dd-\
175fec7eb251"],

Cell[BoxData[{
 RowBox[{"Clear", "[", "ExportPDFReport", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ExportPDFReport", "[", 
   RowBox[{"myList_", ",", 
    RowBox[{"fileName_:", "\"\<\>\""}], ",", 
    RowBox[{"orient_:", "\"\<Portrait\>\""}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "report", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"report", "=", 
      RowBox[{"CreateDocument", "[", 
       RowBox[{"Null", ",", 
        RowBox[{"PageHeaders", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"None", ",", "None", ",", "None"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"None", ",", "None", ",", "None"}], "}"}]}], "}"}]}], ",", 
        RowBox[{"PrintingOptions", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<PrintingMargins\>\"", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"20", ",", "20"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"20", ",", "20"}], "}"}]}], "}"}]}], ",", 
           RowBox[{"\"\<PaperOrientation\>\"", "\[Rule]", "orient"}]}], 
          "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Paste", "[", 
         RowBox[{"report", ",", "i"}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"NotebookWrite", "[", 
         RowBox[{"report", ",", 
          RowBox[{"Cell", "[", 
           RowBox[{"\"\<\>\"", ",", "\"\<PageBreak\>\"", ",", 
            RowBox[{"PageBreakBelow", "\[Rule]", "True"}], ",", 
            RowBox[{"CellMargins", "\[Rule]", "0"}], ",", 
            RowBox[{"PageWidth", "->", "PaperWidth"}]}], "]"}]}], "]"}], 
        ";"}], "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "myList"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Export", "[", 
      RowBox[{"fileName", ",", "report"}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"NotebookClose", "[", "report", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Clear", "[", "report", "]"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7726137259458046`*^9, 3.7726137820011764`*^9}, {
  3.7726138208140416`*^9, 3.7726138229583435`*^9}, {3.7726138774164076`*^9, 
  3.7726139325756903`*^9}, {3.7726149404625187`*^9, 3.7726149546497173`*^9}, {
  3.7726151209857864`*^9, 3.7726151358973207`*^9}},
 CellLabel->"In[33]:=",ExpressionUUID->"16efcd7e-9f56-404a-a009-f57d23330fa8"]
}, Closed]],

Cell[CellGroupData[{

Cell["B-spline Fitting", "Subsubsection",
 CellChangeTimes->{{3.7721956011480026`*^9, 3.7721956065135736`*^9}, 
   3.7729574589233685`*^9},ExpressionUUID->"b1d763af-b5f2-4358-b264-\
98000317053b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"0", "th", " ", "order", " ", "b"}], "-", 
    RowBox[{"spline", " ", "basis", " ", "function"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"UnitComp", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"min", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"max", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "_Real", ",", "0"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"min", "\[LessEqual]", "x", "<", "max"}], ",", "1", ",", 
         "0"}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"RuntimeAttributes", "->", 
        RowBox[{"{", "Listable", "}"}]}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"b", "-", 
     RowBox[{"spline", " ", "division", " ", "i"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"DivComp1", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"d", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"u", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"d", "\[Equal]", "0."}], ",", "x", ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"x", "-", "u"}], ")"}], "/", "d"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"RuntimeAttributes", "\[Rule]", 
        RowBox[{"{", "Listable", "}"}]}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"b", "-", 
     RowBox[{"spline", " ", "division", " ", "i"}], "+", "1"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"DivComp2", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"d", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"u", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"d", "\[Equal]", "0."}], ",", "x", ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"u", "-", "x"}], ")"}], "/", "d"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"RuntimeAttributes", "\[Rule]", 
        RowBox[{"{", "Listable", "}"}]}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"generate", " ", "b"}], "-", 
      RowBox[{
      "spline", " ", "basis", " ", "functions", " ", "with", " ", "order", 
       " ", "p", " ", "and", " ", "knots"}]}], ",", " ", 
     RowBox[{"for", " ", "x", " ", "points"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Basis", "[", 
     RowBox[{"p_", ",", "knots_", ",", "x_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"Basis", "[", 
      RowBox[{"p", ",", "knots", ",", "x"}], "]"}], "=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "kn", ",", "ui", ",", "ui1", ",", "uip", ",", "uip1", ",", "bi", ",", 
         "bi1", ",", "d1", ",", "d2"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "function", " ", "cashes", " ", "the", " ", "basis", " ", "function", 
         " ", "already", " ", "calculated"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"p", "==", "0"}], ",", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"first", " ", "order", " ", "splines"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"kn", "=", "knots"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"kn", "[", 
            RowBox[{"[", 
             RowBox[{"-", "1"}], "]"}], "]"}], "=", 
           RowBox[{
            RowBox[{"kn", "[", 
             RowBox[{"[", 
              RowBox[{"-", "1"}], "]"}], "]"}], "+", "1"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "get", " ", "the", " ", "0", "th", " ", "order", " ", "basis", " ",
             "function"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"UnitComp", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", "x"}], "]"}], "&"}], "/@", 
           RowBox[{"Partition", "[", 
            RowBox[{"kn", ",", "2", ",", "1"}], "]"}]}]}], 
         "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"higher", " ", "order", " ", "splines"}], ",", " ", 
           RowBox[{"first", " ", "partition", " ", "the", " ", "knots"}]}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"ui", ",", "ui1", ",", "uip", ",", "uip1"}], "}"}], "=", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{"Partition", "[", 
              RowBox[{"knots", ",", 
               RowBox[{"2", "+", "p"}], ",", "1"}], "]"}], "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "2", ",", 
                 RowBox[{"-", "2"}], ",", 
                 RowBox[{"-", "1"}]}], "}"}]}], "]"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "get", " ", "the", " ", "basis", " ", "functions", " ", "of", " ",
              "order", " ", "p"}], "-", 
            RowBox[{"1", " ", "and", " ", "partition"}]}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"bi", ",", "bi1"}], "}"}], "=", 
           RowBox[{"Transpose", "[", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"Basis", "[", 
               RowBox[{
                RowBox[{"p", "-", "1"}], ",", "knots", ",", "x"}], "]"}], ",",
               "2", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "get", " ", "the", " ", "basis", " ", "functions", " ", "of", " ", 
            "order", " ", "p"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"DivComp1", "[", 
             RowBox[{
              RowBox[{"uip", "-", "ui"}], ",", "ui", ",", "x"}], "]"}], 
            "bi"}], "+", 
           RowBox[{
            RowBox[{"DivComp2", "[", 
             RowBox[{
              RowBox[{"uip1", "-", "ui1"}], ",", "uip1", ",", "x"}], "]"}], 
            "bi1"}]}]}]}], "\[IndentingNewLine]", "]"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "BSplineBasisFunctions", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"SplineDegree", "\[Rule]", "2"}], ",", 
       RowBox[{"SplineKnotsNumber", "\[Rule]", "50"}], ",", 
       RowBox[{"SplineRegularization", "\[Rule]", "0"}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"BSplineBasisFunctions", "[", 
     RowBox[{"Npts_", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{
     RowBox[{"BSplineBasisFunctions", "[", 
      RowBox[{"Npts", ",", "opts"}], "]"}], "=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
        "cpn", ",", "sd", ",", "reg", ",", "len", ",", "paras", ",", "knots", 
         ",", "coeffMat", ",", "coeffMatR", ",", "coeffMatDD", ",", 
         "smooth"}], "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"cpn", "=", 
         RowBox[{"OptionValue", "[", "SplineKnotsNumber", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"sd", "=", 
         RowBox[{"OptionValue", "[", "SplineDegree", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"reg", "=", 
         RowBox[{"OptionValue", "[", "SplineRegularization", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"len", "=", 
         RowBox[{"Length", "[", "pts", "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
          "define", " ", "the", " ", "bpline", " ", "points", " ", "x"}], " ",
           "=", " ", 
          RowBox[{"[", 
           RowBox[{"0", ",", "1"}], "]"}]}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"paras", "=", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"0", ",", "1", ",", 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"Npts", "-", "1", "+", "2"}], ")"}]}]}], "]"}], "//", 
          "N"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "define", " ", "the", " ", "knots", " ", "for", " ", "order", " ", 
          "sd", " ", "and", " ", "cpn", " ", "degrees", " ", "of", " ", 
          "freedome"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"knots", "=", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0.", ",", "sd"}], "]"}], ",", 
           RowBox[{"N", "@", 
            RowBox[{"Range", "[", 
             RowBox[{"0", ",", "1", ",", 
              RowBox[{"1", "/", 
               RowBox[{"(", 
                RowBox[{"cpn", "-", "sd"}], ")"}]}]}], "]"}]}], ",", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"1.", ",", "sd"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"generate", " ", "the", " ", "coefficient", " ", "matrix"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"coeffMat", "=", 
         RowBox[{"Basis", "[", 
          RowBox[{"sd", ",", "knots", ",", "paras"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"maker", " ", "reg", " ", "coefficient", " ", "matirx"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"coeffMatDD", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"ListConvolve", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"1", ",", 
               RowBox[{"-", "2"}], ",", "1"}], "}"}], ",", "#"}], "]"}], 
           "&"}], "/@", "coeffMat"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"coeffMat", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"coeffMat", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", 
             RowBox[{"2", ";;", 
              RowBox[{"-", "2"}]}]}], "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"smooth", "=", 
         RowBox[{"reg", " ", 
          RowBox[{"(", 
           RowBox[{"coeffMatDD", ".", 
            RowBox[{"Transpose", "[", "coeffMatDD", "]"}]}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"coeffMatR", "=", 
         RowBox[{"Join", "[", 
          RowBox[{"coeffMat", ",", "smooth"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", "output", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"coeffMat", ",", "coeffMatR"}], "}"}]}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "BSplineCurveFit", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"SplineDegree", "\[Rule]", "2"}], ",", 
       RowBox[{"SplineKnotsNumber", "\[Rule]", "50"}], ",", 
       RowBox[{"SplineRegularization", "\[Rule]", "0"}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"BSplineCurveFit", "[", 
     RowBox[{"pts_", ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
       "paras", ",", "knots", ",", "coeffMat", ",", "ctrlpts", ",", "cpn", 
        ",", "sd", ",", "reg", ",", " ", "len", ",", " ", "Amat", ",", 
        "ptsP"}], "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"cpn", "=", 
        RowBox[{"OptionValue", "[", "SplineKnotsNumber", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"coeffMat", ",", "Amat"}], "}"}], "=", 
        RowBox[{"BSplineBasisFunctions", "[", 
         RowBox[{
          RowBox[{"Length", "[", "pts", "]"}], ",", "opts"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"ptsP", "=", 
        RowBox[{"PadRight", "[", 
         RowBox[{"pts", ",", 
          RowBox[{"Length", "[", "Amat", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ctrlpts", "=", 
        RowBox[{"LLeastSquares", "[", 
         RowBox[{"Amat", ",", "ptsP"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Amat", ".", "ctrlpts"}], ")"}], "[", 
        RowBox[{"[", 
         RowBox[{";;", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"-", "cpn"}], "-", "1"}], ")"}]}], "]"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.771999083612375*^9, 3.771999083612375*^9}, {
   3.7719992509610023`*^9, 3.7719992532296886`*^9}, {3.771999300546359*^9, 
   3.7719994330763855`*^9}, {3.772011677488332*^9, 3.772011677918476*^9}, {
   3.772012398412928*^9, 3.7720124243960257`*^9}, 3.772013053894867*^9, {
   3.772013550199317*^9, 3.772013588451052*^9}, {3.772013621892967*^9, 
   3.772013640764172*^9}, {3.7720136894025187`*^9, 3.7720137110600843`*^9}, {
   3.7720137604093328`*^9, 3.772013762375557*^9}, {3.7720137995113096`*^9, 
   3.7720139235094767`*^9}, 3.7720323222619753`*^9, {3.772039360629966*^9, 
   3.7720393610545325`*^9}, {3.772039696873712*^9, 3.7720396976707735`*^9}, {
   3.7721955918312645`*^9, 3.772195592115264*^9}, {3.772195623964116*^9, 
   3.7721956775099783`*^9}, {3.7721957179764132`*^9, 
   3.7721962507502575`*^9}, {3.7721962848055143`*^9, 3.77219631046085*^9}, {
   3.7721963587701*^9, 3.7721963839369783`*^9}, 3.7721964533002615`*^9, {
   3.772196968291004*^9, 3.772196977183381*^9}, {3.7721970161052303`*^9, 
   3.772197020065042*^9}, {3.772290396064582*^9, 3.7722904281225805`*^9}, {
   3.77229055484443*^9, 3.772290560281541*^9}, {3.7722906071806145`*^9, 
   3.772290609218363*^9}, {3.7722908946892443`*^9, 3.772290896212245*^9}, {
   3.7722909313220744`*^9, 3.7722909664192133`*^9}, {3.7723326013513975`*^9, 
   3.7723326070323696`*^9}, {3.772333737539317*^9, 3.7723337530298543`*^9}, {
   3.7723337916161866`*^9, 3.7723337969696736`*^9}, {3.772334377060842*^9, 
   3.7723343771928406`*^9}, {3.7723475529950857`*^9, 
   3.7723475544506207`*^9}, {3.772348983126458*^9, 3.772348988152861*^9}, {
   3.772350925953249*^9, 3.7723509272296305`*^9}, {3.7724237266776214`*^9, 
   3.7724239757312546`*^9}, {3.7724340650474334`*^9, 
   3.7724341015231366`*^9}, {3.772434142903205*^9, 3.772434161399188*^9}, {
   3.772435068856804*^9, 3.7724351225839252`*^9}, {3.772435152697013*^9, 
   3.7724352254949408`*^9}, {3.7724353266021957`*^9, 
   3.7724353730574875`*^9}, {3.772436540508361*^9, 3.7724365527284365`*^9}, {
   3.7724419520389957`*^9, 3.7724419521787677`*^9}, {3.7724420191887474`*^9, 
   3.7724420508034463`*^9}, 3.7724500764586225`*^9, {3.7724516697536936`*^9, 
   3.7724517011485276`*^9}, {3.772951702996681*^9, 3.7729517130871305`*^9}},
 CellLabel->"In[35]:=",ExpressionUUID->"f320a7f6-c054-4646-bf89-9ce42ce0f6ac"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spectra Functions", "Subsubsection",
 CellChangeTimes->{{3.7722181918385444`*^9, 
  3.7722181961199565`*^9}},ExpressionUUID->"f5e28823-8e37-4e46-b09e-\
68deeb29355d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"GetTimePPMRange", "[", 
   RowBox[{"spec_", ",", "dt_", ",", "field_", ",", "nuc_", ",", "shift_"}], 
   "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "Nsamp", ",", "ppmFreq", ",", "time", ",", "bw", ",", "ppmBW", ",", 
      "ppm"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Nsamp", "=", 
      RowBox[{"Length", "[", "spec", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"time", "=", 
      RowBox[{"Range", "[", 
       RowBox[{"dt", ",", 
        RowBox[{"Nsamp", " ", "dt"}], ",", "dt"}], " ", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"ppmFreq", "=", 
      RowBox[{
       RowBox[{"GyromagneticRatio", "[", "nuc", "]"}], "field"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"frequency", " ", "per", " ", "ppm"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"bw", "=", 
      RowBox[{"1", "/", "dt"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"acquisition", " ", "band", " ", "with"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"ppmBW", "=", 
      RowBox[{"bw", "/", "ppmFreq"}]}], ";", 
     RowBox[{"(*", 
      RowBox[{"ppm", " ", "range"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"ppm", "=", 
      RowBox[{"Range", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"-", "ppmBW"}], "/", "2"}], "+", "shift"}], ",", 
        RowBox[{
         RowBox[{"ppmBW", "/", "2"}], "+", "shift"}], ",", 
        RowBox[{"ppmBW", "/", 
         RowBox[{"(", 
          RowBox[{"Nsamp", "-", "1"}], ")"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"time", ",", 
       RowBox[{"Reverse", "@", "ppm"}], ",", 
       RowBox[{"{", 
        RowBox[{"Nsamp", ",", "ppmFreq"}], "}"}]}], "}"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7722178360929823`*^9, 3.772217976367292*^9}, {
  3.772218011136241*^9, 3.7722180144357777`*^9}, {3.77221807054512*^9, 
  3.7722181182938156`*^9}, {3.772220090242445*^9, 3.7722201203164797`*^9}, {
  3.7723320991371517`*^9, 3.772332106420498*^9}, {3.7723321497602215`*^9, 
  3.772332155005872*^9}},
 CellLabel->"In[43]:=",ExpressionUUID->"89c311ca-da81-4cb3-b6d9-67f9a9fabeb4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"interpolate", " ", "the", " ", "time", " ", 
    RowBox[{"domain", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ChangeDwellTime", "[", 
     RowBox[{"time_", ",", "dwOrig_", ",", "dwTar_"}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "NsampOrig", ",", "timeOrig", ",", "NsampTar", ",", "timeTar"}], "}"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "get", " ", "time", " ", "of", " ", "original", " ", "signal"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"NsampOrig", "=", 
        RowBox[{"Length", "@", "time"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"timeOrig", "=", 
        RowBox[{"dwOrig", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Range", "[", "NsampOrig", "]"}], "-", "1"}], ")"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"define", " ", "time", " ", "of", " ", "new", " ", "signal"}],
         "*)"}], "\[IndentingNewLine]", 
       RowBox[{"NsampTar", "=", 
        RowBox[{"Round", "[", 
         RowBox[{
          RowBox[{"Max", "[", "timeOrig", "]"}], "/", "dwTar"}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"timeTar", "=", 
        RowBox[{"dwTar", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Range", "[", "NsampTar", "]"}], "-", "1"}], ")"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Interpolate", " ", "the", " ", "time", " ", "to", " ", "the", " ", 
         "new", " ", "timescale"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Interpolation", "[", 
         RowBox[{
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"timeOrig", ",", "time"}], "}"}], "]"}], ",", 
          RowBox[{"InterpolationOrder", "\[Rule]", "1"}]}], "]"}], "[", 
        "timeTar", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "find", " ", "the", " ", "first", " ", "and", " ", "second", " ", "order",
      " ", "phase", " ", "correction", " ", "of", " ", "spectra"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PhaseCorrect", "[", 
     RowBox[{"ppm_", ",", "speci_", ",", 
      RowBox[{"phi0_", "?", "NumericQ"}], ",", 
      RowBox[{"phi1_", "?", "NumericQ"}]}], "]"}], ":=", 
    RowBox[{"PhaseCorrectC", "[", 
     RowBox[{"ppm", ",", "speci", ",", "phi0", ",", "phi1"}], "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PhaseCorrectC", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ppm", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"speci", ",", "_Complex", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi0", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi1", ",", "_Real", ",", "0"}], "}"}]}], "}"}], ",", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", "spec", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"spec", "=", 
           RowBox[{
            RowBox[{"Exp", "[", 
             RowBox[{
              RowBox[{"-", "I"}], 
              RowBox[{"(", 
               RowBox[{"phi0", "+", 
                RowBox[{"phi1", " ", "ppm"}]}], ")"}]}], "]"}], "speci"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"Arg", "[", "spec", "]"}], ")"}], "^", "2"}], "]"}], 
           "+", 
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Abs", "[", "spec", "]"}], "-", 
               RowBox[{"Re", "[", "spec", "]"}]}], ")"}], "^", "2"}], 
            "]"}]}]}]}], "\[IndentingNewLine]", "]"}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PhaseCorrectSpectra", "[", 
     RowBox[{"ppm_", ",", "spect_"}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"phi0", ",", "phi1"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"Exp", "[", 
           RowBox[{
            RowBox[{"-", "I"}], 
            RowBox[{"(", 
             RowBox[{"phi0", "+", 
              RowBox[{"phi1", " ", "ppm"}]}], ")"}]}], "]"}], "spect"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi0", ",", "phi1"}], "}"}]}], "}"}], "/.", 
       RowBox[{
        RowBox[{"FindMinimum", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"PhaseCorrect", "[", 
             RowBox[{"ppm", ",", "spect", ",", "phi0", ",", "phi1"}], "]"}], 
            ",", 
            RowBox[{
             RowBox[{"-", "Pi"}], "<", "phi0", "<", "Pi"}], ",", 
            RowBox[{
             RowBox[{"-", "Pi"}], "<", "phi1", "<", "Pi"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"phi0", ",", "0"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"phi1", ",", "0"}], "}"}]}], "}"}]}], "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"Clear", "[", "EstimateLineWidth", "]"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Function", " ", "to", " ", "estimate", " ", "linewidth"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"EstimateLineWidth", "[", 
     RowBox[{"ppm_", ",", "spec_", ",", 
      RowBox[{"{", 
       RowBox[{"peaks_", ",", "amps_"}], "}"}]}], "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "dppm", ",", "deltaf", ",", "corrf", ",", "max", ",", "corrf2", ",", 
        "pts", ",", "pos", ",", "ppmC"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "define", " ", "delta", " ", "ppm", " ", "and", " ", "the", " ", 
        "delta", " ", "function", " ", "for", " ", "correlation"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dppm", "=", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"ppm", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "-", 
          RowBox[{"ppm", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ")"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"deltaf", "=", 
        RowBox[{"0", " ", "ppm"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"deltaf", "[", 
         RowBox[{"[", 
          RowBox[{"Flatten", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Position", "[", 
              RowBox[{"ppm", ",", 
               RowBox[{"First", "@", 
                RowBox[{"Nearest", "[", 
                 RowBox[{"ppm", ",", "#"}], "]"}]}]}], "]"}], "&"}], "/@", 
            "peaks"}], "]"}], "]"}], "]"}], "=", "amps"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "perfomr", " ", "correlation", " ", "of", " ", "spectra", " ", "with",
          " ", "delta", " ", "function"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"corrf", "=", 
        RowBox[{"Abs", "@", 
         RowBox[{"ListCorrelate", "[", 
          RowBox[{"deltaf", ",", "spec", ",", 
           RowBox[{"Round", "[", 
            RowBox[{
             RowBox[{"Length", "[", "deltaf", "]"}], "/", "2"}], "]"}], ",", 
           "0"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"corrf", "=", 
        RowBox[{
         RowBox[{"Length", "[", "corrf", "]"}], 
         RowBox[{"corrf", "/", 
          RowBox[{"Max", "[", "corrf", "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Find", " ", "max", " ", "correlation", " ", "and", " ", "position"}],
         "*)"}], "\[IndentingNewLine]", 
       RowBox[{"max", "=", 
        RowBox[{"Max", "[", "corrf", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"pos", "=", 
        RowBox[{
         RowBox[{"Position", "[", 
          RowBox[{"corrf", ",", "max"}], "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"pos", ",", "max"}], "}"}], "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FindPeaks", "[", "corrf", "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"pos", "=", 
          RowBox[{
           RowBox[{"Position", "[", 
            RowBox[{"pos", ",", 
             RowBox[{"First", "@", 
              RowBox[{"Nearest", "[", 
               RowBox[{"pos", ",", 
                RowBox[{
                 RowBox[{"Length", "[", "ppm", "]"}], "/", "2"}]}], "]"}]}]}],
             "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"max", "=", 
          RowBox[{"max", "[", 
           RowBox[{"[", "pos", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"pos", "=", 
          RowBox[{
           RowBox[{"Position", "[", 
            RowBox[{"corrf", ",", "max"}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "find", " ", "two", " ", "points", " ", "closest", " ", "to", " ", 
         "FWHM"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"corrf2", "=", 
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Range", "[", 
            RowBox[{"Length", "[", "corrf", "]"}], "]"}], ",", 
           RowBox[{
            RowBox[{"-", 
             RowBox[{"Abs", "[", 
              RowBox[{"corrf", "-", 
               RowBox[{"max", "/", "2"}]}], "]"}]}], "+", 
            RowBox[{"max", "/", "2"}]}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"pts", "=", 
        RowBox[{"Nearest", "[", 
         RowBox[{"corrf2", ",", 
          RowBox[{"{", 
           RowBox[{"pos", ",", 
            RowBox[{"max", "/", "2"}]}], "}"}], ",", "2"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"debugging", " ", "plots"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"ppmC", "=", 
          RowBox[{"dppm", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"Length", "[", "corrf", "]"}], "]"}], "-", 
             RowBox[{
              RowBox[{"Length", "[", "corrf", "]"}], "/", "2"}]}], ")"}]}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"Print", "[", 
          RowBox[{"Show", "[", 
           RowBox[{
            RowBox[{"PlotSpectra", "[", 
             RowBox[{"ppm", ",", "deltaf", ",", 
              RowBox[{"GridLineSpacing", "\[Rule]", "10"}]}], "]"}], ",", 
            RowBox[{"ImageSize", "\[Rule]", "300"}]}], "]"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Print", "[", 
          RowBox[{"Show", "[", 
           RowBox[{
            RowBox[{"PlotSpectra", "[", 
             RowBox[{"ppm", ",", "spec", ",", 
              RowBox[{"GridLineSpacing", "\[Rule]", "10"}]}], "]"}], ",", 
            RowBox[{"ImageSize", "\[Rule]", "300"}]}], "]"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Print", "[", 
          RowBox[{"Show", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"PlotSpectra", "[", 
             RowBox[{"ppmC", ",", "corrf", ",", 
              RowBox[{"GridLineSpacing", "\[Rule]", "10"}]}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"ListLinePlot", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"ppmC", "[", 
                    RowBox[{"[", 
                    RowBox[{"pts", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "1"}], "]"}], "]"}], "]"}], "]"}], 
                   ",", 
                   RowBox[{"pts", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "}"}], "]"}], 
                ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"ppmC", "[", 
                    RowBox[{"[", "pos", "]"}], "]"}], ",", "0"}], "}"}], ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"ppmC", "[", 
                    RowBox[{"[", "pos", "]"}], "]"}], ",", "max"}], "}"}]}], 
                 "}"}]}], "}"}], ",", 
              RowBox[{"PlotStyle", "\[Rule]", 
               RowBox[{"Directive", "[", 
                RowBox[{"{", 
                 RowBox[{"Thick", ",", "Red"}], "}"}], "]"}]}], 
              "\[IndentingNewLine]", ",", 
              RowBox[{"ScalingFunctions", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"\"\<Reverse\>\"", ",", "Automatic"}], "}"}]}]}], 
             "]"}], "\[IndentingNewLine]", ",", 
            RowBox[{"ImageSize", "\[Rule]", "300"}]}], "]"}], "]"}], ";"}], 
        "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "calculate", " ", "the", " ", "estimated", " ", "lw", " ", "and", " ",
          "shift"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"dppm", 
          RowBox[{"(", 
           RowBox[{"Subtract", "@@", 
            RowBox[{"(", 
             RowBox[{"Reverse", "@", 
              RowBox[{"Sort", "@", 
               RowBox[{"pts", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ")"}]}], 
           ")"}]}], ",", 
         RowBox[{
          RowBox[{"-", "dppm"}], 
          RowBox[{"(", 
           RowBox[{"pos", "-", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Length", "[", "ppm", "]"}], "/", "2."}], ")"}]}], 
           ")"}]}]}], "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "function", " ", "to", " ", "estimate", " ", "phase", " ", "form", " ", 
     "abs", " ", "fitting", " ", "of", " ", "baiss", " ", "spectra"}], "*)"}],
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"EstimatePhaseShift", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"ppm_", ",", "spec_"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"time_", ",", "fids_"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"gam_", ",", "eps_"}], "}"}], ",", "gyro_"}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "specsC", ",", "fit", ",", "phi0f", ",", "phi1f", ",", "phi"}], "}"}],
        ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"specsC", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"ShiftedFourier", "[", 
             RowBox[{"SpectraTimeShift", "[", 
              RowBox[{"time", ",", "#", ",", "gyro", ",", 
               RowBox[{"{", 
                RowBox[{"gam", ",", "eps"}], "}"}]}], "]"}], "]"}], "&"}], "/@",
            "fids"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"fit", "=", 
         RowBox[{"specsC", ".", 
          RowBox[{"NNLeastSquares", "[", 
           RowBox[{
            RowBox[{"Abs", "[", "specsC", "]"}], ",", 
            RowBox[{"Abs", "[", "spec", "]"}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"phi", "=", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"phi0f", ",", "phi1f"}], "}"}], "/.", 
          RowBox[{
           RowBox[{"FindMinimum", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"PhaseError", "[", 
                RowBox[{"ppm", ",", "fit", ",", "spec", ",", 
                 RowBox[{"{", 
                  RowBox[{"phi0f", ",", "phi1f"}], "}"}]}], "]"}], ",", 
               RowBox[{
                RowBox[{"-", "Pi"}], "<", "phi0f", "<", "Pi"}], ",", 
               RowBox[{
                RowBox[{"-", "Pi"}], "<", "phi1f", "<", "Pi"}]}], "}"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"phi0f", ",", "0"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"phi1f", ",", "0"}], "}"}]}], "\[IndentingNewLine]", 
            "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        "phi"}]}], "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"debugging", " ", "plots"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"FlipView", "[", 
          RowBox[{"{", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Show", "[", 
             RowBox[{
              RowBox[{"PlotSpectra", "[", 
               RowBox[{"ppm", ",", 
                RowBox[{"SpectraPhaseShift", "[", 
                 RowBox[{"ppm", ",", "fit", ",", "phi"}], "]"}], ",", 
                RowBox[{"GridLineSpacing", "\[Rule]", "10"}]}], "]"}], ",", 
              RowBox[{"ImageSize", "\[Rule]", "300"}]}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"Show", "[", 
             RowBox[{
              RowBox[{"PlotSpectra", "[", 
               RowBox[{"ppm", ",", "spec", ",", 
                RowBox[{"GridLineSpacing", "\[Rule]", "10"}]}], "]"}], ",", 
              RowBox[{"ImageSize", "\[Rule]", "300"}]}], "]"}]}], 
           "\[IndentingNewLine]", "}"}], "]"}], "]"}], ";", 
        "\[IndentingNewLine]", "phi"}], "\[IndentingNewLine]", "*)"}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "find", " ", "the", " ", "first", " ", "and", " ", "second", " ", "order",
      " ", "phase", " ", "correction", " ", "of", " ", "spectra"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PhaseError", "[", 
     RowBox[{"ppm_", ",", "speci_", ",", "spect_", ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"phi0_", "?", "NumericQ"}], ",", 
        RowBox[{"phi1_", "?", "NumericQ"}]}], "}"}]}], "]"}], ":=", 
    RowBox[{"PhaseErrorC", "[", 
     RowBox[{"ppm", ",", "speci", ",", "spect", ",", "phi0", ",", "phi1"}], 
     "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PhaseErrorC", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ppm", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"speci", ",", "_Complex", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"spect", ",", "_Complex", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi0", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi1", ",", "_Real", ",", "0"}], "}"}]}], "}"}], ",", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", "spec", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"spec", "=", 
           RowBox[{
            RowBox[{"Exp", "[", 
             RowBox[{
              RowBox[{"-", "I"}], 
              RowBox[{"(", 
               RowBox[{"phi0", "+", 
                RowBox[{"phi1", " ", "ppm"}]}], ")"}]}], "]"}], "speci"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Re", "[", "spect", "]"}], "-", 
               RowBox[{"Re", "[", "spec", "]"}]}], ")"}], "^", "2"}], "]"}], 
           "+", 
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Im", "[", "spect", "]"}], "-", 
               RowBox[{"Im", "[", "spec", "]"}]}], ")"}], "^", "2"}], 
            "]"}]}]}]}], "\[IndentingNewLine]", "]"}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "shift", " ", "first", " ", "and", " ", "second", " ", "order", " ", 
     "phase", " ", "of", " ", "spectra"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SpectraPhaseShift", "[", 
      RowBox[{"ppm_", ",", "spec_", ",", "phi0_"}], "]"}], ":=", 
     RowBox[{"SpectraPhaseShiftC", "[", 
      RowBox[{"ppm", ",", "spec", ",", "phi0", ",", "0."}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SpectraPhaseShift", "[", 
      RowBox[{"ppm_", ",", "spec_", ",", 
       RowBox[{"{", 
        RowBox[{"phi0_", ",", "phi1_"}], "}"}]}], "]"}], ":=", 
     RowBox[{"SpectraPhaseShiftC", "[", 
      RowBox[{"ppm", ",", "spec", ",", "phi0", ",", "phi1"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SpectraPhaseShiftC", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ppm", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"spec", ",", "_Complex", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi0", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"phi1", ",", "_Real", ",", "0"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Exp", "[", 
         RowBox[{
          RowBox[{"-", "I"}], 
          RowBox[{"(", 
           RowBox[{"phi0", "+", 
            RowBox[{"phi1", " ", "ppm"}]}], ")"}]}], "]"}], "spec"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"RuntimeAttributes", "\[Rule]", 
        RowBox[{"{", "Listable", "}"}]}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "shift", " ", "frequency", " ", "and", " ", "linewidth", " ", "of", " ", 
     "FID"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SpectraTimeShift", "[", 
      RowBox[{"time_", ",", "times_", ",", "gyro_", ",", "gam_"}], "]"}], ":=", 
     RowBox[{"SpectraTimeShiftC", "[", 
      RowBox[{"time", ",", "times", ",", "gyro", ",", "gam", ",", "0."}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"SpectraTimeShift", "[", 
      RowBox[{"time_", ",", "times_", ",", "gyro_", ",", 
       RowBox[{"{", 
        RowBox[{"gam_", ",", "eps_"}], "}"}]}], "]"}], ":=", 
     RowBox[{"SpectraTimeShiftC", "[", 
      RowBox[{"time", ",", "times", ",", "gyro", ",", "gam", ",", "eps"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SpectraTimeShiftC", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"time", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"times", ",", "_Complex", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"gyro", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"gam", ",", "_Real", ",", "0"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"eps", ",", "_Real", ",", "0"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Exp", "[", 
         RowBox[{
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{"gam", "-", 
             RowBox[{"eps", " ", "gyro", " ", "2", " ", "Pi", " ", "I"}]}], 
            ")"}]}], "time"}], "]"}], "times"}], ",", "\[IndentingNewLine]", 
       RowBox[{"RuntimeAttributes", "\[Rule]", 
        RowBox[{"{", "Listable", "}"}]}], ",", 
       RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.772198046074195*^9, 3.77219815564079*^9}, {
   3.772359706178655*^9, 3.772359739906337*^9}, {3.772359949109659*^9, 
   3.7723599514749813`*^9}, {3.772363381041108*^9, 3.7723633858690453`*^9}, {
   3.772369258829553*^9, 3.7723692750495644`*^9}, {3.7723713980029383`*^9, 
   3.772371407596326*^9}, {3.7724337625165663`*^9, 3.7724337629688053`*^9}, {
   3.7724520029441547`*^9, 3.7724520518645186`*^9}, {3.7724521264631777`*^9, 
   3.772452134260131*^9}, {3.7724523618543186`*^9, 3.7724523720422015`*^9}, {
   3.77245419755846*^9, 3.7724542018618526`*^9}, {3.772454457470837*^9, 
   3.7724544801080327`*^9}, {3.772454531841648*^9, 3.772454592408121*^9}, {
   3.7724546483419123`*^9, 3.772454672431987*^9}, {3.7724547431490984`*^9, 
   3.7724547519485044`*^9}, {3.772454905674469*^9, 3.772454907580557*^9}, {
   3.772455550893298*^9, 3.7724555816529975`*^9}, {3.772455626239572*^9, 
   3.7724556365449905`*^9}, {3.7724557147860994`*^9, 3.772455759209264*^9}, {
   3.7724558054633055`*^9, 3.772455819588893*^9}, {3.772455961472313*^9, 
   3.7724559696771297`*^9}, {3.7724577572994237`*^9, 
   3.7724577610309377`*^9}, {3.7724583667216005`*^9, 3.772458375674675*^9}, {
   3.7725082957330675`*^9, 3.772508298921735*^9}, {3.7725085810363493`*^9, 
   3.7725086477269664`*^9}, 3.7726098105070176`*^9, {3.772965857385454*^9, 
   3.772965859418883*^9}, {3.7729791909215336`*^9, 3.772979205169983*^9}, {
   3.7729800250208993`*^9, 3.7729800254688973`*^9}, {3.773024761260558*^9, 
   3.7730247614805574`*^9}, {3.773029418248619*^9, 3.7730294924393687`*^9}, {
   3.7730296031292067`*^9, 3.7730296374398146`*^9}, {3.7730297379447994`*^9, 
   3.773029741110639*^9}, 3.7730298470827246`*^9, {3.7730299420957456`*^9, 
   3.7730300443119764`*^9}, {3.773030076422881*^9, 3.773030119321293*^9}, {
   3.7730326224328566`*^9, 3.773032735505234*^9}, {3.7730328416955676`*^9, 
   3.7730328572480545`*^9}, {3.7730329014268627`*^9, 
   3.7730329295643053`*^9}, {3.7730329784673324`*^9, 3.773032989712593*^9}, {
   3.773033222274102*^9, 3.773033312531435*^9}, {3.773033365892604*^9, 
   3.773033394130659*^9}, {3.7730334338535533`*^9, 3.773033507859785*^9}, {
   3.7730335718261137`*^9, 3.7730336177696185`*^9}, {3.7730337000832305`*^9, 
   3.7730338103612814`*^9}, {3.7730338444716578`*^9, 3.773033844762442*^9}, {
   3.7730344113871574`*^9, 3.773034452007618*^9}, {3.7730345022804327`*^9, 
   3.77303453136489*^9}, 3.7730424624702744`*^9, {3.773048166320687*^9, 
   3.773048171005887*^9}, {3.7730483088659286`*^9, 3.7730483778145*^9}, 
   3.7730538443650103`*^9, 3.7730544515700836`*^9, {3.7730724393205748`*^9, 
   3.7730724446622667`*^9}, {3.773110618580117*^9, 3.773110622727838*^9}, {
   3.77311067711691*^9, 3.7731106917024918`*^9}},
 CellLabel->"In[44]:=",ExpressionUUID->"ebd88506-163d-4b4f-8fe8-c3289922d58e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Plot Spectra", "Subsubsection",
 CellChangeTimes->{{3.7724286252575936`*^9, 
  3.7724286295343046`*^9}},ExpressionUUID->"8abccdd1-4e6c-4f1c-bb57-\
8afe0984ea79"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "PlotSpectra", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", 
      RowBox[{"Method", "\[Rule]", "\"\<All\>\""}], ",", 
      RowBox[{"GridLines", "\[Rule]", 
       RowBox[{"{", "}"}]}], ",", 
      RowBox[{"PlotColor", "\[Rule]", "Automatic"}], ",", 
      RowBox[{"GridLineSpacing", "\[Rule]", ".1"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PlotSpectra", "[", 
    RowBox[{"ppm_", ",", "spec_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "fun", ",", "plot", ",", "grid", ",", "or", ",", "rr", ",", "col"}], 
      "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fun", "=", 
       RowBox[{"Switch", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "Method", "]"}], ",", "\"\<Abs\>\"", ",", 
         RowBox[{"{", "Abs", "}"}], ",", "\"\<Re\>\"", ",", 
         RowBox[{"{", "Re", "}"}], ",", "\"\<Im\>\"", ",", 
         RowBox[{"{", "Im", "}"}], ",", "\"\<ReIm\>\"", ",", 
         RowBox[{"{", 
          RowBox[{"Im", ",", "Re"}], "}"}], ",", "\"\<All\>\"", ",", 
         RowBox[{"{", 
          RowBox[{"Im", ",", "Re", ",", "Abs"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"plot", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"ppm", ",", "#"}], "}"}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "@", "spec"}], "&"}], "/@", "fun"}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"grid", "=", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"Range", "[", 
          RowBox[{
           RowBox[{"Round", "[", 
            RowBox[{"Min", "[", "ppm", "]"}], "]"}], ",", 
           RowBox[{"Round", "[", 
            RowBox[{"Max", "[", "ppm", "]"}], "]"}], ",", 
           RowBox[{"OptionValue", "[", "GridLineSpacing", "]"}]}], "]"}], ",", 
         RowBox[{"OptionValue", "[", "GridLines", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"rr", "=", 
       RowBox[{"OptionValue", "[", "PlotRange", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Switch", "[", 
       RowBox[{"rr", ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"_", ",", "Full"}], "}"}], ",", 
        RowBox[{
         RowBox[{"rr", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "=", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Max", "[", 
             RowBox[{"Abs", "[", "spec", "]"}], "]"}]}], ",", 
           RowBox[{"Max", "[", 
            RowBox[{"Abs", "[", "spec", "]"}], "]"}]}], "}"}]}], ",", 
        "\[IndentingNewLine]", "Full", ",", 
        RowBox[{"rr", "=", 
         RowBox[{"{", 
          RowBox[{"Full", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Max", "[", 
               RowBox[{"Abs", "[", "spec", "]"}], "]"}]}], ",", 
             RowBox[{"Max", "[", 
              RowBox[{"Abs", "[", "spec", "]"}], "]"}]}], "}"}]}], "}"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"col", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "PlotColor", "]"}], "===", 
          "Automatic"}], ",", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"Gray", ",", 
             RowBox[{"{", 
              RowBox[{"Red", ",", "Thin"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"Thick", ",", "Black"}], "}"}]}], "}"}], "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Length", "[", "fun", "]"}]}], ";;"}], "]"}], "]"}], 
          ")"}], ",", 
         RowBox[{"OptionValue", "[", "PlotColor", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ListLinePlot", "[", 
       RowBox[{"plot", ",", 
        RowBox[{"PlotStyle", "\[Rule]", "col"}], ",", 
        RowBox[{"PlotRange", "\[Rule]", "rr"}], ",", 
        RowBox[{"GridLines", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"grid", ",", "None"}], "}"}]}], ",", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"AspectRatio", "\[Rule]", ".2"}], ",", 
        RowBox[{"ImageSize", "\[Rule]", "1000"}], ",", 
        RowBox[{"ScalingFunctions", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"\"\<Reverse\>\"", ",", "Automatic"}], "}"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Frame", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"False", ",", "False"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"True", ",", "False"}], "}"}]}], "}"}]}], ",", 
        RowBox[{"FrameStyle", "\[Rule]", 
         RowBox[{"Directive", "[", 
          RowBox[{"{", 
           RowBox[{"Thick", ",", "Black"}], "}"}], "]"}]}], ",", 
        RowBox[{"FrameLabel", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"\"\<PPM\>\"", ",", "None"}], "}"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"LabelStyle", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"Bold", ",", "14", ",", "Black"}], "}"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "PlotFid", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", 
      RowBox[{"Method", "\[Rule]", "\"\<All\>\""}], ",", 
      RowBox[{"GridLines", "\[Rule]", 
       RowBox[{"{", "}"}]}], ",", 
      RowBox[{"PlotColor", "\[Rule]", "Automatic"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"PlotFid", "[", 
   RowBox[{"time_", ",", "fid_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"fun", ",", "plot", ",", "grid", ",", "rr", ",", "col"}], "}"}], 
    ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"fun", "=", 
      RowBox[{"Switch", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "Method", "]"}], ",", "\"\<Abs\>\"", ",", 
        RowBox[{"{", "Abs", "}"}], ",", "\"\<ReIm\>\"", ",", 
        RowBox[{"{", 
         RowBox[{"Im", ",", "Re"}], "}"}], ",", "\"\<All\>\"", ",", 
        RowBox[{"{", 
         RowBox[{"Im", ",", "Re", ",", "Abs"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"plot", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{"time", ",", "#"}], "}"}], "]"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "@", "fid"}], "&"}], "/@", "fun"}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"grid", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"Round", "[", 
           RowBox[{"Min", "[", "time", "]"}], "]"}], ",", 
          RowBox[{"Round", "[", 
           RowBox[{"Max", "[", "time", "]"}], "]"}], ",", ".05"}], "]"}], ",", 
        RowBox[{"OptionValue", "[", "GridLines", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"rr", "=", 
      RowBox[{"OptionValue", "[", "PlotRange", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Switch", "[", 
      RowBox[{"rr", ",", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"_", ",", "Full"}], "}"}], ",", 
       RowBox[{
        RowBox[{"rr", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", 
           RowBox[{"Max", "[", 
            RowBox[{"Abs", "[", "fid", "]"}], "]"}]}], ",", 
          RowBox[{"Max", "[", 
           RowBox[{"Abs", "[", "fid", "]"}], "]"}]}], "}"}]}], ",", 
       "\[IndentingNewLine]", "Full", ",", 
       RowBox[{"rr", "=", 
        RowBox[{"{", 
         RowBox[{"Full", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", 
             RowBox[{"Max", "[", 
              RowBox[{"Abs", "[", "fid", "]"}], "]"}]}], ",", 
            RowBox[{"Max", "[", 
             RowBox[{"Abs", "[", "fid", "]"}], "]"}]}], "}"}]}], "}"}]}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"col", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "PlotColor", "]"}], "===", "Automatic"}],
         ",", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"Gray", ",", 
            RowBox[{"{", 
             RowBox[{"Red", ",", "Thin"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"Thick", ",", "Black"}], "}"}]}], "}"}], "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"-", 
             RowBox[{"Length", "[", "fun", "]"}]}], ";;"}], "]"}], "]"}], 
         ")"}], ",", 
        RowBox[{"OptionValue", "[", "PlotColor", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"ListLinePlot", "[", 
      RowBox[{"plot", ",", 
       RowBox[{"PlotStyle", "\[Rule]", "col"}], ",", 
       RowBox[{"PlotRange", "\[Rule]", "rr"}], ",", 
       RowBox[{"GridLines", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"grid", ",", 
          RowBox[{"{", "0", "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"AspectRatio", "\[Rule]", ".2"}], ",", 
       RowBox[{"ImageSize", "\[Rule]", "1000"}], ",", "\[IndentingNewLine]", 
       RowBox[{"Frame", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"False", ",", "False"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"True", ",", "False"}], "}"}]}], "}"}]}], ",", 
       RowBox[{"FrameStyle", "\[Rule]", 
        RowBox[{"Directive", "[", 
         RowBox[{"{", 
          RowBox[{"Thick", ",", "Black"}], "}"}], "]"}]}], ",", 
       RowBox[{"FrameLabel", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"\"\<time [s]\>\"", ",", "None"}], "}"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"LabelStyle", "\[Rule]", 
        RowBox[{"{", 
         RowBox[{"Bold", ",", "14", ",", "Black"}], "}"}]}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.772269646011748*^9, 3.772269650672936*^9}, {
   3.772273280850865*^9, 3.7722733028904395`*^9}, {3.772273334720564*^9, 
   3.772273388032287*^9}, {3.772332055060508*^9, 3.7723320581967154`*^9}, {
   3.77235146052907*^9, 3.772351480383258*^9}, {3.7723600572549458`*^9, 
   3.7723601141332617`*^9}, {3.7723601511109405`*^9, 3.772360169177533*^9}, {
   3.772360222838688*^9, 3.772360241237647*^9}, {3.7723602757648587`*^9, 
   3.772360488868739*^9}, {3.7723605272890224`*^9, 3.7723605530787797`*^9}, {
   3.772360632693113*^9, 3.7723607456384706`*^9}, {3.77236078282563*^9, 
   3.7723608037524447`*^9}, {3.772360843704671*^9, 3.772360851957856*^9}, {
   3.7723608934174595`*^9, 3.7723609753519616`*^9}, {3.7723610218001456`*^9, 
   3.7723610432404237`*^9}, 3.772362048043562*^9, {3.772445783796933*^9, 
   3.7724457997417784`*^9}, {3.772445890430952*^9, 3.7724459130859756`*^9}, {
   3.7724459781588526`*^9, 3.77244598857279*^9}, {3.772446245196827*^9, 
   3.772446264543176*^9}, {3.772456698296853*^9, 3.7724567645937967`*^9}, {
   3.7726091225811987`*^9, 3.772609159742593*^9}, {3.772609190194927*^9, 
   3.7726093708912845`*^9}, {3.7726094027195272`*^9, 3.772609418636464*^9}, {
   3.772609449068486*^9, 3.772609575291218*^9}, {3.77260962551489*^9, 
   3.7726096605759907`*^9}, {3.77260969645055*^9, 3.772609696797393*^9}, 
   3.772625153692021*^9, {3.77295157875636*^9, 3.7729515862083015`*^9}, {
   3.772957989269106*^9, 3.7729580110101714`*^9}},
 CellLabel->"In[59]:=",ExpressionUUID->"584724f1-bd73-48f9-ae2b-0661fb0e651e"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1200, 1877},
WindowMargins->{{-1208, Automatic}, {Automatic, -337}},
FrontEndVersion->"12.0 for Microsoft Windows (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 202, 3, 28, "Input",ExpressionUUID->"e87bfa00-329f-4381-911b-60eb90e20db1"],
Cell[CellGroupData[{
Cell[785, 27, 167, 3, 53, "Subsection",ExpressionUUID->"d60b526a-3d3a-464b-9c8a-bf93e405e86b"],
Cell[CellGroupData[{
Cell[977, 34, 170, 3, 44, "Subsubsection",ExpressionUUID->"6be6feff-d302-4d2e-8df0-7736d77183ea"],
Cell[1150, 39, 56938, 1184, 3658, "Input",ExpressionUUID->"2da03b54-2ab5-4bfd-945b-2fcc6789c7e0"]
}, Open  ]],
Cell[CellGroupData[{
Cell[58125, 1228, 164, 2, 44, "Subsubsection",ExpressionUUID->"6e5e8f9b-00fa-4d00-90f6-6a5356e04754"],
Cell[58292, 1232, 5347, 145, 485, "Input",ExpressionUUID->"c1086614-593b-4876-aa74-0b554c05e5e2"]
}, Closed]],
Cell[CellGroupData[{
Cell[63676, 1382, 169, 3, 36, "Subsubsection",ExpressionUUID->"1458e431-bb72-4b43-98f0-1bdab7d25876"],
Cell[63848, 1387, 2969, 78, 181, "Input",ExpressionUUID->"ad7afa91-eed3-415a-bb58-ba1a510918e6"]
}, Closed]],
Cell[CellGroupData[{
Cell[66854, 1470, 223, 4, 36, "Subsubsection",ExpressionUUID->"10e1083e-7b72-4abf-b1ce-29828290270d"],
Cell[67080, 1476, 6819, 184, 523, "Input",ExpressionUUID->"775b2077-1a5d-45dc-8de4-df450bc059ed"]
}, Closed]],
Cell[CellGroupData[{
Cell[73936, 1665, 182, 3, 36, "Subsubsection",ExpressionUUID->"0717d4ae-c3bb-4417-a368-e9e5d3f50c69"],
Cell[74121, 1670, 13200, 328, 1568, "Input",ExpressionUUID->"56c31631-f92c-4e6c-be99-ab187a0aa9b0"],
Cell[87324, 2000, 3462, 80, 295, "Input",ExpressionUUID->"897c8227-96bf-4bff-9f88-a77a17e32cac"]
}, Closed]],
Cell[CellGroupData[{
Cell[90823, 2085, 169, 3, 36, "Subsubsection",ExpressionUUID->"a13fb7bd-c93c-4b9c-93e2-bfefabc06531"],
Cell[90995, 2090, 19399, 506, 1758, "Input",ExpressionUUID->"ecd69e73-ae79-4f1a-bd6b-8479fc5ecdad"],
Cell[110397, 2598, 4644, 132, 314, "Input",ExpressionUUID->"a48c84e2-fa99-458a-b826-bbadfb8c5d99"]
}, Closed]],
Cell[CellGroupData[{
Cell[115078, 2735, 170, 3, 36, "Subsubsection",ExpressionUUID->"cc74f5d7-4d95-4ad7-a5dd-175fec7eb251"],
Cell[115251, 2740, 2594, 59, 200, "Input",ExpressionUUID->"16efcd7e-9f56-404a-a009-f57d23330fa8"]
}, Closed]],
Cell[CellGroupData[{
Cell[117882, 2804, 196, 3, 36, "Subsubsection",ExpressionUUID->"b1d763af-b5f2-4358-b264-98000317053b"],
Cell[118081, 2809, 16496, 391, 1378, "Input",ExpressionUUID->"f320a7f6-c054-4646-bf89-9ce42ce0f6ac"]
}, Open  ]],
Cell[CellGroupData[{
Cell[134614, 3205, 172, 3, 44, "Subsubsection",ExpressionUUID->"f5e28823-8e37-4e46-b09e-68deeb29355d"],
Cell[134789, 3210, 2262, 57, 200, "Input",ExpressionUUID->"89c311ca-da81-4cb3-b6d9-67f9a9fabeb4"],
Cell[137054, 3269, 27565, 665, 2005, "Input",ExpressionUUID->"ebd88506-163d-4b4f-8fe8-c3289922d58e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[164656, 3939, 167, 3, 44, "Subsubsection",ExpressionUUID->"8abccdd1-4e6c-4f1c-bb57-8afe0984ea79"],
Cell[164826, 3944, 12353, 301, 941, "Input",ExpressionUUID->"584724f1-bd73-48f9-ae2b-0661fb0e651e"]
}, Open  ]]
}, Open  ]]
}
]
*)

